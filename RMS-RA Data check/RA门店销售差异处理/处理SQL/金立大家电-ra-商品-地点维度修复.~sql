--比较RA-金立系统的商品-地点维度记录,在接口中有，RA无
SELECT COUNT(1)
  FROM (SELECT DISTINCT JL.ITEM, JL.LOC
          FROM RA_RMS.BBG_RA_ITEM_LOC_JL_V@RA_RMS_DBLINK JL
         WHERE JL.LOC = &NEW_LOC) A
 WHERE NOT EXISTS (SELECT 1
          FROM (SELECT DISTINCT T.ITEM, T.LOC
                  FROM RADM.BBG_RA_ITEM_LOC_D T
                 WHERE T.LOC = &NEW_LOC) B
         WHERE A.ITEM = B.ITEM
           AND A.LOC = B.LOC);

--创建金立新开门店的商品-地点维度导入RA的存储过程
CALL BBG_JL_ITEM_LOC_NEW_PROC(130032);

--JIN_JL_ITEM_LOC_TMP
CREATE TABLE RADM.JIN_JL_ITEM_LOC_TMP AS
SELECT /*+PARALLEL(16)*/
DISTINCT A.ITEM, A.LOC
  FROM BBG_RA_ITEM_LOC_JL_V@RA_JL A;
DROP TABLE RADM.JIN_JL_ITEM_LOC_TMP;

--JIN_RA_ITEM_LOC_TMP	
CREATE TABLE RADM.JIN_RA_ITEM_LOC_TMP AS
  SELECT /*+PARALLEL(16)*/
  DISTINCT A.ITEM, A.LOC
    FROM RADM.BBG_RA_ITEM_LOC_D A;
DROP TABLE RADM.JIN_RA_ITEM_LOC_TMP;

--JIN_ITEM_LOC_DIFF_TMP			
CREATE TABLE RADM.JIN_ITEM_LOC_DIFF_TMP AS
SELECT *
  FROM RADM.JIN_JL_ITEM_LOC_TMP A
 WHERE NOT EXISTS (SELECT 1
          FROM RADM.JIN_RA_ITEM_LOC_TMP B
         WHERE A.ITEM = B.ITEM
           AND A.LOC = B.LOC);
					 
--insert BBG_RA_ITEM_LOC_DS
TRUNCATE TABLE RADM.BBG_RA_ITEM_LOC_DS;
TRUNCATE TABLE RADM.C_LOAD_DATES;
insert into RADM.BBG_RA_ITEM_LOC_DS T
  (ITEM,
   LOC,
   NBB,
   NBO,
   SALE_TYPE,
   STANDARD_GROSS_MARGIN,
   PROMO_GROSS_MARGIN,
   BUSINESS_MODE,
   ZC_IND,
   ZG_IND,
   HERO_ITEM_IND,
   REF_NO1,
   REF_NO2,
   REF_NO3,
   REF_NO4,
   SRC_EFF_FROM_DT,
   INTEGRATION_ID,
   NEW_ITEM_FLAG,
   DATASOURCE_NUM_ID,
   ETL_PROC_WID)
  select /*+PARALLEL(16)*/
   S.ITEM,
   S.LOC,
   S.NBB,
   S.NBO,
   S.SALE_TYPE,
   S.STANDARD_GROSS_MARGIN,
   S.PROMO_GROSS_MARGIN,
   S.BUSINESS_MODE,
   S.ZC_IND,
   S.BBG_ZG_IND ZG_IND,
   S.HERO_ITEM_IND,
   S.REF_NO1,
   S.REF_NO2,
   S.REF_NO3,
   S.REF_NO4,
   S.SRC_EFF_FROM_DT,
   S.INTEGRATION_ID,
   S.NEW_ITEM_FLAG,
   S.DATASOURCE_NUM_ID,
   S.ETL_PROC_WID
    from (SELECT /*+PARALLEL(16)*/
           JL.ITEM,
           TO_NUMBER(JL.LOC) LOC,
           JL.NBB,
           JL.NBO,
           JL.SALE_TYPE,
           JL.STANDARD_GROSS_MARGIN,
           JL.PROMO_GROSS_MARGIN,
           JL.BUSINESS_MODE,
           JL.ZC_IND,
           JL.BBG_ZG_IND,
           JL.HERO_ITEM_IND,
           JL.REF_NO1,
           TO_NUMBER(JL.REF_NO2) REF_NO2,
           JL.REF_NO3,
           JL.REF_NO4,
           JL.SRC_EFF_FROM_DT,
           JL.ITEM || '~' || JL.LOC INTEGRATION_ID,
           JL.NEW_ITEM_FLAG,
           1 DATASOURCE_NUM_ID,
           100 ETL_PROC_WID
            FROM RA_RMS.BBG_RA_ITEM_LOC_JL_V@RA_RMS_DBLINK JL
           WHERE EXISTS (SELECT /*+PARALLEL(16)*/
                   1
                    FROM RADM.JIN_ITEM_LOC_DIFF_TMP A
                   WHERE JL.ITEM = A.ITEM
                     AND JL.LOC = A.LOC)) S;
COMMIT;

--W_RTL_SLS_TRX_IT_LC_DY_FS
TRUNCATE TABLE RADM.W_RTL_SLS_TRX_IT_LC_DY_FS_BAK;
INSERT INTO RADM.W_RTL_SLS_TRX_IT_LC_DY_FS_BAK 
SELECT * FROM RADM.W_RTL_SLS_TRX_IT_LC_DY_FS;
TRUNCATE TABLE RADM.W_RTL_SLS_TRX_IT_LC_DY_FS;
INSERT INTO RADM.W_RTL_SLS_TRX_IT_LC_DY_FS
  SELECT *
    FROM RADM.W_RTL_SLS_TRX_IT_LC_DY_FS_BAK A
   WHERE EXISTS (SELECT 1
            FROM RADM.JIN_ITEM_LOC_DIFF_TMP B
           WHERE A.PROD_IT_NUM = B.ITEM
             AND A.ORG_NUM = B.LOC);
						 
--W_RTL_SLS_TRX_IT_LC_DY_TMP
SELECT * FROM RABATCHER.W_RTL_SLS_TRX_IT_LC_DY_TMP;

--INSERT W_RTL_SLS_TRX_IT_LC_DY_FS
TRUNCATE TABLE RADM.W_RTL_SLS_TRX_IT_LC_DY_FS;
TRUNCATE TABLE RADM.C_LOAD_DATES;
INSERT INTO RADM.W_RTL_SLS_TRX_IT_LC_DY_FS
  (SLS_TRX_ID,
   PROD_IT_NUM,
   ORG_NUM,
   DAY_DT,
   VOUCHER_ID,
   RTL_TYPE_CODE,
   MIN_NUM,
   EMPLOYEE_NUM,
   SLS_QTY,
   SLS_AMT_LCL,
   SLS_PROFIT_AMT_LCL,
   SLS_TAX_AMT_LCL,
   SLS_EMP_DISC_AMT_LCL,
   SLS_MANUAL_COUNT,
   SLS_SCAN_COUNT,
   RET_QTY,
   RET_AMT_LCL,
   RET_PROFIT_AMT_LCL,
   RET_TAX_AMT_LCL,
   RET_EMP_DISC_AMT_LCL,
   RET_MANUAL_COUNT,
   RET_SCAN_COUNT,
   REJECT_FLG,
   SLS_MANUAL_MKDN_AMT_LCL,
   SLS_MANUAL_MKUP_AMT_LCL,
   RET_MANUAL_MKDN_AMT_LCL,
   RET_MANUAL_MKUP_AMT_LCL,
   EXCHANGE_DT,
   AUX1_CHANGED_ON_DT,
   AUX2_CHANGED_ON_DT,
   AUX3_CHANGED_ON_DT,
   AUX4_CHANGED_ON_DT,
   CHANGED_BY_ID,
   CHANGED_ON_DT,
   CREATED_BY_ID,
   CREATED_ON_DT,
   DATASOURCE_NUM_ID,
   DELETE_FLG,
   DOC_CURR_CODE,
   ETL_THREAD_VAL,
   GLOBAL1_EXCHANGE_RATE,
   GLOBAL2_EXCHANGE_RATE,
   GLOBAL3_EXCHANGE_RATE,
   INTEGRATION_ID,
   LOC_CURR_CODE,
   LOC_EXCHANGE_RATE,
   TENANT_ID,
   X_CUSTOM,
   BBG_RETAIL_TYPE_ID,
   BBG_SERVICE_SATISFACTION,
   SRC_REF_NO1,
   SRC_REF_NO2,
   SRC_REF_NO3,
   SRC_REF_NO6,
   SRC_REF_NO7,
   SRC_REF_NO8,
   BBG_REFERENCE_DO1,
   BBG_REFERENCE_DO2,
   BBG_REFERENCE_DO3,
   BBG_REFERENCE_DO4,
   BBG_REFERENCE_DO5,
   BBG_REFERENCE_FO1,
   BBG_REFERENCE_FO2,
   BBG_REFERENCE_FO3,
   BBG_REFERENCE_FO4,
   BBG_REFERENCE_FO5,
   BBG_REFERENCE_FO6,
   BBG_REFERENCE_FO7,
   BBG_REFERENCE_FO8,
   BBG_REFERENCE_FO9,
   BBG_REFERENCE_FO10,
   HYK_NO)
  SELECT T.SLS_TRX_ID,
         T.PROD_IT_NUM,
         T.ORG_NUM,
         T.DAY_DT,
         -1 VOUCHER_ID,
         T.RTL_TYPE_CODE,
         T.MIN_NUM,
         -1 EMPLOYEE_NUM,
         T.SLS_QTY,
         T.SLS_AMT_LCL,
         T.SLS_PROFIT_AMT_LCL,
         T.SLS_TAX_AMT_LCL,
         T.SLS_EMP_DISC_AMT_LCL,
         T.SLS_MANUAL_COUNT,
         T.SLS_SCAN_COUNT,
         T.RET_QTY RET_QTY,
         T.RET_AMT_LCL RET_AMT_LCL,
         T.RET_PROFIT_AMT_LCL,
         T.RET_TAX_AMT_LCL RET_TAX_AMT_LCL,
         T.RET_EMP_DISC_AMT_LCL,
         T.RET_MANUAL_COUNT,
         T.RET_SCAN_COUNT,
         NULL REJECT_FLG,
         T.SLS_MANUAL_MKDN_AMT_LCL,
         T.SLS_MANUAL_MKUP_AMT_LCL,
         T.RET_MANUAL_MKDN_AMT_LCL,
         T.RET_MANUAL_MKUP_AMT_LCL,
         T.DAY_DT EXCHANGE_DT,
         NULL AUX1_CHANGED_ON_DT,
         NULL AUX2_CHANGED_ON_DT,
         NULL AUX3_CHANGED_ON_DT,
         NULL AUX4_CHANGED_ON_DT,
         -1 CHANGED_BY_ID,
         SYSDATE CHANGED_ON_DT,
         -1 CREATED_BY_ID,
         SYSDATE CREATED_ON_DT,
         1 DATASOURCE_NUM_ID,
         NULL DELETE_FLG,
         'CNY' DOC_CURR_CODE,
         (SELECT L.THREAD_VAL
            FROM RA_RMS.RA_RESTART_LOC@RA_RMS_DBLINK L
           WHERE T.ORG_NUM = L.DRIVER_VALUE
             AND L.SCENARIO_NAME = 'SDE_BBG_RETAIL_SALESTRANSACTIONFACT') ETL_THREAD_VAL,
         NULL GLOBAL1_EXCHANGE_RATE,
         NULL GLOBAL2_EXCHANGE_RATE,
         NULL GLOBAL3_EXCHANGE_RATE,
         T.SLS_TRX_ID || '~' || T.PROD_IT_NUM || '~-1~' ||
         TO_CHAR(T.DAY_DT, 'DD-MON-YY', 'NLS_DATE_LANGUAGE = American') INTEGRATION_ID,
         'CNY' LOC_CURR_CODE,
         NULL LOC_EXCHANGE_RATE,
         NULL TENANT_ID,
         NULL X_CUSTOM,
         T.BBG_RETAIL_TYPE_ID,
         3.5 BBG_SERVICE_SATISFACTION,
         NULL SRC_REF_NO1,
         NULL SRC_REF_NO2,
         NULL SRC_REF_NO3,
         T.PROD_IT_NUM SRC_REF_NO6,
         NULL SRC_REF_NO7,
         NULL SRC_REF_NO8,
         NULL BBG_REFERENCE_DO1,
         NULL BBG_REFERENCE_DO2,
         NULL BBG_REFERENCE_DO3,
         NULL BBG_REFERENCE_DO4,
         NULL BBG_REFERENCE_DO5,
         NULL BBG_REFERENCE_FO1,
         NULL BBG_REFERENCE_FO2,
         NULL BBG_REFERENCE_FO3,
         NULL BBG_REFERENCE_FO4,
         NULL BBG_REFERENCE_FO5,
         NULL BBG_REFERENCE_FO6,
         NULL BBG_REFERENCE_FO7,
         NULL BBG_REFERENCE_FO8,
         NULL BBG_REFERENCE_FO9,
         NULL BBG_REFERENCE_FO10,
         T.HYK_NO HYK_NO
    FROM (SELECT SLS_TRX_ID,
                 PROD_IT_NUM,
                 ORG_NUM,
                 DAY_DT,
                 VOUCHER_ID,
                 RTL_TYPE_CODE,
                 MIN_NUM,
                 SLS_QTY,
                 SLS_AMT_LCL,
                 SLS_PROFIT_AMT_LCL,
                 SLS_TAX_AMT_LCL,
                 SLS_EMP_DISC_AMT_LCL,
                 SLS_MANUAL_COUNT,
                 SLS_SCAN_COUNT,
                 -RET_QTY                 RET_QTY,
                 -RET_AMT_LCL             RET_AMT_LCL,
                 -RET_PROFIT_AMT_LCL      RET_PROFIT_AMT_LCL,
                 -RET_TAX_AMT_LCL         RET_TAX_AMT_LCL,
                 -RET_EMP_DISC_AMT_LCL    RET_EMP_DISC_AMT_LCL,
                 -RET_MANUAL_COUNT        RET_MANUAL_COUNT,
                 -RET_SCAN_COUNT          RET_SCAN_COUNT,
                 SLS_MANUAL_MKDN_AMT_LCL,
                 SLS_MANUAL_MKUP_AMT_LCL,
                 -RET_MANUAL_MKDN_AMT_LCL RET_MANUAL_MKDN_AMT_LCL,
                 -RET_MANUAL_MKUP_AMT_LCL RET_MANUAL_MKUP_AMT_LCL,
                 BBG_RETAIL_TYPE_ID,
                 HYK_NO
            FROM BBG_RA_SLS_TRX_JL_V@RA_JL
           WHERE DAY_DT = DATE '2016-01-02') T
   WHERE EXISTS (SELECT 1
            FROM RADM.JIN_ITEM_LOC_DIFF_TMP A
           WHERE T.PROD_IT_NUM = A.ITEM
             AND T.ORG_NUM = A.LOC);
