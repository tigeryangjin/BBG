/*
非9101：
2015/6/20 120073 dept23
120073:
800270037
---------------------------------------------
2015/7/25 120123,120205,dept22
120123:
800019678
800019680
800020247
800020256
800020325
800020330
800021244
800021256
800021424
800021427
800184423
800184764
800193421
800237411
800240743
800344489
800344491
800344538

120205:
800019388
800019389
800019678
800019746
800020247
800020256
800020325
800020330
800021244
800021256
800021424
800184764
800237411
800240743
800340890
800344489
800344753

----------------------------------------------------------------
2015/7/28 120043 dept29
120043:
101790427

***************************************************************
9101:
2015/12/10 120141
2015/12/11 120066
2015/12/28 120146
2016/1/22  120140

*/

--清空BBG_XTERN_RDWT
TRUNCATE TABLE RA_RMS.BBG_XTERN_RDWT;
--从BBG_XTERN_RDWT_HIST插入BBG_XTERN_RDWT
--2015-06-20

CREATE TABLE RA_RMS.BBG_XTERN_RDWT_BAK AS
SELECT *
  FROM RA_RMS.BBG_XTERN_RDWT_HIST
 WHERE BUSINESS_DT = '20150620'
   AND LOCATION = '0000120073'
   AND ITEM = '800270037';
	 
INSERT INTO RA_RMS.BBG_XTERN_RDWT
  SELECT * FROM RA_RMS.BBG_XTERN_RDWT_BAK;
COMMIT;
DROP TABLE RA_RMS.BBG_XTERN_RDWT_BAK;
--2015-07-25
CREATE TABLE RA_RMS.BBG_XTERN_RDWT_BAK AS
  SELECT *
    FROM RA_RMS.BBG_XTERN_RDWT_HIST
   WHERE BUSINESS_DT = '20150725'
     AND LOCATION = '0000120123'
     AND ITEM IN ('800019678',
                  '800019680',
                  '800020247',
                  '800020256',
                  '800020325',
                  '800020330',
                  '800021244',
                  '800021256',
                  '800021424',
                  '800021427',
                  '800184423',
                  '800184764',
                  '800193421',
                  '800237411',
                  '800240743',
                  '800344489',
                  '800344491',
                  '800344538');
INSERT INTO RA_RMS.BBG_XTERN_RDWT
  SELECT * FROM RA_RMS.BBG_XTERN_RDWT_BAK;
COMMIT;
DROP TABLE RA_RMS.BBG_XTERN_RDWT_BAK;

CREATE TABLE RA_RMS.BBG_XTERN_RDWT_BAK AS
  SELECT *
    FROM RA_RMS.BBG_XTERN_RDWT_HIST
   WHERE BUSINESS_DT = '20150725'
     AND LOCATION = '0000120205'
     AND ITEM IN ('800019388',
                  '800019389',
                  '800019678',
                  '800019746',
                  '800020247',
                  '800020256',
                  '800020325',
                  '800020330',
                  '800021244',
                  '800021256',
                  '800021424',
                  '800184764',
                  '800237411',
                  '800240743',
                  '800340890',
                  '800344489',
                  '800344753');
INSERT INTO RA_RMS.BBG_XTERN_RDWT
  SELECT * FROM RA_RMS.BBG_XTERN_RDWT_BAK;
COMMIT;
DROP TABLE RA_RMS.BBG_XTERN_RDWT_BAK;
--2015-07-28
CREATE TABLE RA_RMS.BBG_XTERN_RDWT_BAK AS
  SELECT *
    FROM RA_RMS.BBG_XTERN_RDWT_HIST
   WHERE BUSINESS_DT = '20150728'
     AND LOCATION = '0000120043'
     AND ITEM = '101790427';
INSERT INTO RA_RMS.BBG_XTERN_RDWT
  SELECT * FROM RA_RMS.BBG_XTERN_RDWT_BAK;
COMMIT;
DROP TABLE RA_RMS.BBG_XTERN_RDWT_BAK;

--合并备份
CREATE TABLE RA_RMS.BBG_XTERN_RDWT_BAK AS
SELECT * FROM RA_RMS.BBG_XTERN_RDWT;

--BBG_XTERN_RDWT
TRUNCATE TABLE RA_RMS.BBG_XTERN_RDWT;
INSERT INTO RA_RMS.BBG_XTERN_RDWT
SELECT * FROM RA_RMS.BBG_XTERN_RDWT_BAK T WHERE T.BUSINESS_DT='20150728';
COMMIT;

--清空ODI日志
TRUNCATE TABLE RA_RMS.C_LOAD_DATES;
TRUNCATE TABLE RADM.C_LOAD_DATES;

--清空tmp表
TRUNCATE TABLE RABATCHER.W_RTL_SLS_IT_DY_TMP;
TRUNCATE TABLE RABATCHER.W_RTL_SLS_IT_LC_DY_SN_TMP;
TRUNCATE TABLE RABATCHER.W_RTL_SLS_IT_LC_DY_TMP;
TRUNCATE TABLE RABATCHER.W_RTL_SLS_LC_DY_TMP;
TRUNCATE TABLE RABATCHER.W_RTL_SLS_SC_LC_DY_CUR_TMP;
TRUNCATE TABLE RABATCHER.W_RTL_SLS_SC_LC_DY_RC_TMP;
TRUNCATE TABLE RABATCHER.W_RTL_SLS_SC_LC_DY_TMP;
TRUNCATE TABLE RABATCHER.W_RTL_SLS_TRX_IT_LC_DY_TMP;

--修改BBG_RA_ITEM_LOC_SOH_V的日期为重导日期
SELECT * FROM RA_RMS.BBG_RA_ITEM_LOC_SOH_V;

--备份W_RTL_SLS_TRX_IT_LC_DY_FS数据
TRUNCATE TABLE RADM.W_RTL_SLS_TRX_IT_LC_DY_FS_BAK;
INSERT INTO RADM.W_RTL_SLS_TRX_IT_LC_DY_FS_BAK
SELECT * FROM W_RTL_SLS_TRX_IT_LC_DY_FS T;
COMMIT;
--检查W_RTL_SLS_TRX_IT_LC_DY_FS数据
SELECT * FROM W_RTL_SLS_TRX_IT_LC_DY_FS T;

TRUNCATE TABLE RADM.W_RTL_SLS_TRX_IT_LC_DY_FS;
INSERT INTO RADM.W_RTL_SLS_TRX_IT_LC_DY_FS
SELECT * FROM W_RTL_SLS_TRX_IT_LC_DY_FS_BAK T;
COMMIT;

--检查W_RTL_SLS_TRX_IT_LC_DY_TMP数据
SELECT * FROM RABATCHER.W_RTL_SLS_TRX_IT_LC_DY_TMP T;

--***************************************************************
--9101销售修复
--***************************************************************
/*
9101:
2015/12/10 120141 done
2015/12/11 120066 done
2015/12/28 120146 done
2016/1/22  120140 done
*/
--1.update sa_tran_item
SELECT * FROM SA_TRAN_ITEM T WHERE T.DAY=22 AND T.STORE=120140 AND T.REF_NO5=88 FOR UPDATE;

--2.BACKUP DATA
DROP TABLE RA_RMS.BBG_XTERN_RDWT_BAK;
CREATE TABLE RA_RMS.BBG_XTERN_RDWT_BAK AS
SELECT *
  FROM RA_RMS.BBG_XTERN_RDWT_HIST T
 WHERE T.BUSINESS_DT BETWEEN '20151210' AND '20160122'
   AND T.DEPARTMENT = 9101
   AND T.TRANSACTION_TYPE = 'SALE';
	 
--3.
TRUNCATE TABLE RA_RMS.BBG_XTERN_RDWT;
INSERT INTO RA_RMS.BBG_XTERN_RDWT
SELECT * FROM RA_RMS.BBG_XTERN_RDWT_BAK T WHERE T.BUSINESS_DT='20160122';
COMMIT;

SELECT * FROM RA_RMS.BBG_XTERN_RDWT;

--4.修改BBG_RA_ITEM_LOC_SOH_V的日期为重导日期
SELECT * FROM RA_RMS.BBG_RA_ITEM_LOC_SOH_V;

--5.backup to fs_bak
--TRUNCATE TABLE RADM.W_RTL_SLS_TRX_IT_LC_DY_FS_BAK;

INSERT INTO RADM.W_RTL_SLS_TRX_IT_LC_DY_FS_BAK
SELECT * FROM RADM.W_RTL_SLS_TRX_IT_LC_DY_FS;
COMMIT;

TRUNCATE TABLE RADM.W_RTL_SLS_TRX_IT_LC_DY_FS;

INSERT INTO RADM.W_RTL_SLS_TRX_IT_LC_DY_FS
SELECT * FROM RADM.W_RTL_SLS_TRX_IT_LC_DY_FS_BAK;
COMMIT;

--6.
SELECT * FROM RABATCHER.W_RTL_SLS_TRX_IT_LC_DY_TMP;
