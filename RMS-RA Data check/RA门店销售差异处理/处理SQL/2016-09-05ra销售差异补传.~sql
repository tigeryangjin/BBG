CREATE TABLE RADM.IF_TRAN_DATA_20160905 AS
SELECT *
  FROM IF_TRAN_DATA@RA_RMS_DBLINK T
 WHERE T.TRAN_DATE = DATE '2016-09-05'
   AND T.TRAN_CODE IN (1, 3);

--check item loc not in RA
CREATE TABLE RADM.IF_TRAN_DATA_IN_RA_20160905 AS
SELECT SUBSTR(A.INTEGRATION_ID, 1, INSTR(A.INTEGRATION_ID, '~') - 1) ITEM,
       SUBSTR(A.INTEGRATION_ID,
              INSTR(A.INTEGRATION_ID, '~') + 1,
              INSTR(A.INTEGRATION_ID, '~', 11) - 1 -
              INSTR(A.INTEGRATION_ID, '~')) LOC
  FROM RADM.W_RTL_SLS_IT_LC_DY_A A
 WHERE A.DT_WID = 120160905000
   AND (SUBSTR(A.INTEGRATION_ID, 1, INSTR(A.INTEGRATION_ID, '~') - 1),
        SUBSTR(A.INTEGRATION_ID,
               INSTR(A.INTEGRATION_ID, '~') + 1,
               INSTR(A.INTEGRATION_ID, '~', 11) - 1 -
               INSTR(A.INTEGRATION_ID, '~'))) IN
       (SELECT B.ITEM, B.LOCATION FROM RADM.IF_TRAN_DATA_20160905 B);

--********************************************
--没有导入RA的item-loc是因为tran_data_history没有2016-09-05的item-loc记录，造成无法取到AV_COST
--所有销售就没有导入RA.
--********************************************
CREATE TABLE RADM.IF_TRAN_DATA_NOTIN_RA_20160905 AS
SELECT *
  FROM RADM.IF_TRAN_DATA_20160905 A
 WHERE (A.ITEM, A.LOCATION) NOT IN
       (SELECT B.ITEM, B.LOC FROM RADM.IF_TRAN_DATA_IN_RA_20160905 B);

--1.清除ODI日志
TRUNCATE TABLE RA_RMS.C_LOAD_DATES;
TRUNCATE TABLE RADM.C_LOAD_DATES;

--2.
TRUNCATE TABLE RA_RMS.BBG_XTERN_RDWT;
INSERT /*+PARALLEL(16)*/
INTO RA_RMS.BBG_XTERN_RDWT
SELECT /*+PARALLEL(16)*/
 *
  FROM RA_RMS.BBG_XTERN_RDWT_HIST T
 WHERE (T.ITEM, T.LOCATION) IN
       (SELECT A.ITEM, '0000' || A.LOCATION
          FROM IF_TRAN_DATA_NOTIN_RA_20160905@RMS_RA A)
   AND T.BUSINESS_DT = 20160905;
COMMIT;

--3.清空tmp表
TRUNCATE TABLE RABATCHER.W_RTL_SLS_IT_DY_TMP;
TRUNCATE TABLE RABATCHER.W_RTL_SLS_IT_LC_DY_SN_TMP;
TRUNCATE TABLE RABATCHER.W_RTL_SLS_IT_LC_DY_TMP;
TRUNCATE TABLE RABATCHER.W_RTL_SLS_LC_DY_TMP;
TRUNCATE TABLE RABATCHER.W_RTL_SLS_SC_LC_DY_CUR_TMP;
TRUNCATE TABLE RABATCHER.W_RTL_SLS_SC_LC_DY_RC_TMP;
TRUNCATE TABLE RABATCHER.W_RTL_SLS_SC_LC_DY_TMP;
TRUNCATE TABLE RABATCHER.W_RTL_SLS_TRX_IT_LC_DY_TMP;

--4.修改BBG_RA_ITEM_LOC_SOH_V的日期为重导日期
SELECT * FROM RA_RMS.BBG_RA_ITEM_LOC_SOH_V;

--5.检查W_RTL_SLS_TRX_IT_LC_DY_FS
SELECT * FROM RADM.W_RTL_SLS_TRX_IT_LC_DY_FS;

DELETE RADM.W_RTL_SLS_TRX_IT_LC_DY_FS T WHERE T.BBG_SERVICE_SATISFACTION=3.5;



--6.SIL

--7.PLP

--8.修复移动平台销售







SELECT * FROM RADM.IF_TRAN_DATA_20160905;
SELECT * FROM RADM.IF_TRAN_DATA_IN_RA_20160905;

SELECT *
  FROM RADM.IF_TRAN_DATA_20160905 T
 WHERE T.ITEM = 101843710
   AND T.LOCATION = 120188;
SELECT *
  FROM RADM.W_RTL_SLS_IT_LC_DY_A T
 WHERE EXISTS (SELECT 1
          FROM RADM.W_PRODUCT_D P
         WHERE T.PROD_WID = P.ROW_WID
           AND P.PROD_NUM = '101843710')
   AND EXISTS (SELECT 1
          FROM RADM.W_INT_ORG_D O
         WHERE T.ORG_WID = O.ROW_WID
           AND O.ORG_NUM = 120188)
   AND T.DT_WID = 120160905000;
SELECT *
  FROM RA_RMS.BBG_XTERN_RDWT_HIST@RA_RMS_DBLINK T
 WHERE T.BUSINESS_DT = 20160905
   AND T.ITEM = '101843710'
   AND T.LOCATION = '0000120188';

