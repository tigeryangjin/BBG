select T.DAY_DT,
       SUBSTR(P.PROD_CAT5,
              INSTR(P.PROD_CAT5, '~', 1, 2) + 1,
              INSTR(P.PROD_CAT5, '~', 1, 3) -
              (INSTR(P.PROD_CAT5, '~', 1, 2) + 1)) DEPT,
       SUM(T.SLS_QTY - T.RET_QTY) QTY,
       SUM((T.SLS_AMT_LCL - T.RET_AMT_LCL) -
           (T.SLS_TAX_AMT_LCL - T.RET_TAX_AMT_LCL)) NOTAX_AMT,
       SUM(((T.SLS_AMT_LCL - T.RET_AMT_LCL) -
           (T.SLS_TAX_AMT_LCL - T.RET_TAX_AMT_LCL)) -
           (T.SLS_PROFIT_AMT_LCL - T.RET_PROFIT_AMT_LCL)) COST
  from RADM.BBG_RA_SLS_TRX_JL_V T, RADM.W_PRODUCT_D P
 WHERE T.PROD_IT_NUM = P.PROD_NUM
   AND T.DAY_DT BETWEEN P.EFFECTIVE_FROM_DT AND P.EFFECTIVE_TO_DT
 GROUP BY T.DAY_DT,
          SUBSTR(P.PROD_CAT5,
                 INSTR(P.PROD_CAT5, '~', 1, 2) + 1,
                 INSTR(P.PROD_CAT5, '~', 1, 3) -
                 (INSTR(P.PROD_CAT5, '~', 1, 2) + 1))
 ORDER BY T.DAY_DT,
          SUBSTR(P.PROD_CAT5,
                 INSTR(P.PROD_CAT5, '~', 1, 2) + 1,
                 INSTR(P.PROD_CAT5, '~', 1, 3) -
                 (INSTR(P.PROD_CAT5, '~', 1, 2) + 1));

