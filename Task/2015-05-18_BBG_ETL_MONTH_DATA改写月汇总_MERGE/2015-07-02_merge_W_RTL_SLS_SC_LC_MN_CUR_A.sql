MERGE /*+APPEND*/
INTO RADM.W_RTL_SLS_SC_LC_MN_CUR_A T
USING (SELECT 
        PROD_DH_WID,
        ORG_WID,
        max(ORG_SCD1_WID) ORG_SCD1_WID,
        max(ORG_DH_WID) ORG_DH_WID,
        SUBSTR(TO_CHAR(DT_WID), 2, 6) MN_WID,
        RTL_TYPE_WID,
        SUM(NVL(SLS_QTY, 0)) SLS_QTY,
        SUM(NVL(SLS_AMT_LCL, 0)) SLS_AMT_LCL,
        SUM(NVL(SLS_PROFIT_AMT_LCL, 0)) SLS_PROFIT_AMT_LCL,
        SUM(NVL(SLS_MANUAL_MKDN_AMT_LCL, 0)) SLS_MANUAL_MKDN_AMT_LCL,
        SUM(NVL(SLS_MANUAL_MKUP_AMT_LCL, 0)) SLS_MANUAL_MKUP_AMT_LCL,
        SUM(NVL(SLS_TAX_AMT_LCL, 0)) SLS_TAX_AMT_LCL,
        SUM(NVL(SLS_EMP_DISC_AMT_LCL, 0)) SLS_EMP_DISC_AMT_LCL,
        SUM(NVL(SLS_MANUAL_COUNT, 0)) SLS_MANUAL_COUNT,
        SUM(NVL(SLS_SCAN_COUNT, 0)) SLS_SCAN_COUNT,
        SUM(NVL(RET_QTY, 0)) RET_QTY,
        SUM(NVL(RET_AMT_LCL, 0)) RET_AMT_LCL,
        SUM(NVL(RET_PROFIT_AMT_LCL, 0)) RET_PROFIT_AMT_LCL,
        SUM(NVL(RET_MANUAL_MKDN_AMT_LCL, 0)) RET_MANUAL_MKDN_AMT_LCL,
        SUM(NVL(RET_MANUAL_MKUP_AMT_LCL, 0)) RET_MANUAL_MKUP_AMT_LCL,
        SUM(NVL(RET_TAX_AMT_LCL, 0)) RET_TAX_AMT_LCL,
        SUM(NVL(RET_EMP_DISC_AMT_LCL, 0)) RET_EMP_DISC_AMT_LCL,
        SUM(NVL(RET_MANUAL_COUNT, 0)) RET_MANUAL_COUNT,
        SUM(NVL(RET_SCAN_COUNT, 0)) RET_SCAN_COUNT,
        max(SUBSTR(INTEGRATION_ID, 1, INSTR(INTEGRATION_ID, '~', 1, 1)) ||
            SUBSTR(INTEGRATION_ID,
                   INSTR(INTEGRATION_ID, '~', 1, 1) + 1,
                   INSTR(INTEGRATION_ID, '~', 1, 2) -
                   INSTR(INTEGRATION_ID, '~', 1, 1)) ||
            SUBSTR(TO_CHAR(DT_WID), 2, 6) ||
            SUBSTR(INTEGRATION_ID,
                   INSTR(INTEGRATION_ID, '~', 1, 3),
                   LENGTH(INTEGRATION_ID) - INSTR(INTEGRATION_ID, '~', 1, 3) + 1)) INTEGRATION_ID,
        max(GLOBAL1_EXCHANGE_RATE) GLOBAL1_EXCHANGE_RATE,
        max(GLOBAL2_EXCHANGE_RATE) GLOBAL2_EXCHANGE_RATE,
        max(GLOBAL3_EXCHANGE_RATE) GLOBAL3_EXCHANGE_RATE,
        max(LOC_EXCHANGE_RATE) LOC_EXCHANGE_RATE,
        BBG_RETAIL_TYPE_WID,
        SUM(NVL(BBG_CUSTOMER_COUNT, 0)) BBG_CUSTOMER_COUNT,
        SUM(NVL(BBG_SERVICE_SATISFACTION, 0)) BBG_SERVICE_SATISFACTION,
        SYSDATE W_INSERT_DT,
        SYSDATE W_UPDATE_DT,
        max(BBG_REFERENCE_DO1) BBG_REFERENCE_DO1,
        max(BBG_REFERENCE_DO2) BBG_REFERENCE_DO2,
        max(BBG_REFERENCE_DO3) BBG_REFERENCE_DO3,
        max(BBG_REFERENCE_DO4) BBG_REFERENCE_DO4,
        max(BBG_REFERENCE_DO5) BBG_REFERENCE_DO5,
        SUM(BBG_REFERENCE_FO1) BBG_REFERENCE_FO1,
        SUM(BBG_REFERENCE_FO2) BBG_REFERENCE_FO2,
        SUM(BBG_REFERENCE_FO3) BBG_REFERENCE_FO3,
        SUM(BBG_REFERENCE_FO4) BBG_REFERENCE_FO4,
        SUM(BBG_REFERENCE_FO5) BBG_REFERENCE_FO5,
        SUM(BBG_REFERENCE_FO6) BBG_REFERENCE_FO6,
        SUM(BBG_REFERENCE_FO7) BBG_REFERENCE_FO7,
        SUM(BBG_REFERENCE_FO8) BBG_REFERENCE_FO8,
        SUM(BBG_REFERENCE_FO9) BBG_REFERENCE_FO9,
        SUM(BBG_REFERENCE_FO10) BBG_REFERENCE_FO10
         FROM RADM.W_RTL_SLS_SC_LC_DY_CUR_A
        WHERE DT_WID >=
              '1' || TO_CHAR(TRUNC(SYSDATE - 1, 'month'), 'YYYYMMDD') ||
              '000'
        GROUP BY PROD_DH_WID,
                 ORG_WID,
                 SUBSTR(TO_CHAR(DT_WID), 2, 6),
                 RTL_TYPE_WID,
                 BBG_RETAIL_TYPE_WID) S
ON (T.PROD_DH_WID = S.PROD_DH_WID AND T.ORG_WID = S.ORG_WID AND T.MN_WID = S.MN_WID AND T.RTL_TYPE_WID = S.RTL_TYPE_WID AND T.BBG_RETAIL_TYPE_WID = S.BBG_RETAIL_TYPE_WID)
WHEN MATCHED THEN
  UPDATE
     SET T.SLS_QTY                  = S.SLS_QTY,
         T.SLS_AMT_LCL              = S.SLS_AMT_LCL,
         T.SLS_PROFIT_AMT_LCL       = S.SLS_PROFIT_AMT_LCL,
         T.SLS_MANUAL_MKDN_AMT_LCL  = S.SLS_MANUAL_MKDN_AMT_LCL,
         T.SLS_MANUAL_MKUP_AMT_LCL  = S.SLS_MANUAL_MKUP_AMT_LCL,
         T.SLS_TAX_AMT_LCL          = S.SLS_TAX_AMT_LCL,
         T.SLS_EMP_DISC_AMT_LCL     = S.SLS_EMP_DISC_AMT_LCL,
         T.SLS_MANUAL_COUNT         = S.SLS_MANUAL_COUNT,
         T.SLS_SCAN_COUNT           = S.SLS_SCAN_COUNT,
         T.RET_QTY                  = S.RET_QTY,
         T.RET_AMT_LCL              = S.RET_AMT_LCL,
         T.RET_PROFIT_AMT_LCL       = S.RET_PROFIT_AMT_LCL,
         T.RET_MANUAL_MKDN_AMT_LCL  = S.RET_MANUAL_MKDN_AMT_LCL,
         T.RET_MANUAL_MKUP_AMT_LCL  = S.RET_MANUAL_MKUP_AMT_LCL,
         T.RET_TAX_AMT_LCL          = S.RET_TAX_AMT_LCL,
         T.RET_EMP_DISC_AMT_LCL     = S.RET_EMP_DISC_AMT_LCL,
         T.RET_MANUAL_COUNT         = S.RET_MANUAL_COUNT,
         T.RET_SCAN_COUNT           = S.RET_SCAN_COUNT,
         T.BBG_CUSTOMER_COUNT       = S.BBG_CUSTOMER_COUNT,
         T.BBG_SERVICE_SATISFACTION = S.BBG_SERVICE_SATISFACTION,
         T.W_UPDATE_DT              = S.W_UPDATE_DT,
         T.BBG_REFERENCE_FO1        = S.BBG_REFERENCE_FO1,
         T.BBG_REFERENCE_FO2        = S.BBG_REFERENCE_FO2,
         T.BBG_REFERENCE_FO3        = S.BBG_REFERENCE_FO3,
         T.BBG_REFERENCE_FO4        = S.BBG_REFERENCE_FO4,
         T.BBG_REFERENCE_FO5        = S.BBG_REFERENCE_FO5,
         T.BBG_REFERENCE_FO6        = S.BBG_REFERENCE_FO6,
         T.BBG_REFERENCE_FO7        = S.BBG_REFERENCE_FO7,
         T.BBG_REFERENCE_FO8        = S.BBG_REFERENCE_FO8,
         T.BBG_REFERENCE_FO9        = S.BBG_REFERENCE_FO9,
         T.BBG_REFERENCE_FO10       = S.BBG_REFERENCE_FO10
WHEN NOT MATCHED THEN
  INSERT
    (T.PROD_DH_WID,
     T.ORG_WID,
     T.ORG_SCD1_WID,
     T.ORG_DH_WID,
     T.MN_WID,
     T.RTL_TYPE_WID,
     T.SLS_QTY,
     T.SLS_AMT_LCL,
     T.SLS_PROFIT_AMT_LCL,
     T.SLS_MANUAL_MKDN_AMT_LCL,
     T.SLS_MANUAL_MKUP_AMT_LCL,
     T.SLS_TAX_AMT_LCL,
     T.SLS_EMP_DISC_AMT_LCL,
     T.SLS_MANUAL_COUNT,
     T.SLS_SCAN_COUNT,
     T.RET_QTY,
     T.RET_AMT_LCL,
     T.RET_PROFIT_AMT_LCL,
     T.RET_MANUAL_MKDN_AMT_LCL,
     T.RET_MANUAL_MKUP_AMT_LCL,
     T.RET_TAX_AMT_LCL,
     T.RET_EMP_DISC_AMT_LCL,
     T.RET_MANUAL_COUNT,
     T.RET_SCAN_COUNT,
     T.INTEGRATION_ID,
     T.GLOBAL1_EXCHANGE_RATE,
     T.GLOBAL2_EXCHANGE_RATE,
     T.GLOBAL3_EXCHANGE_RATE,
     T.LOC_EXCHANGE_RATE,
     T.BBG_RETAIL_TYPE_WID,
     T.BBG_CUSTOMER_COUNT,
     T.BBG_SERVICE_SATISFACTION,
     T.W_INSERT_DT,
     T.W_UPDATE_DT,
     T.BBG_REFERENCE_DO1,
     T.BBG_REFERENCE_DO2,
     T.BBG_REFERENCE_DO3,
     T.BBG_REFERENCE_DO4,
     T.BBG_REFERENCE_DO5,
     T.BBG_REFERENCE_FO1,
     T.BBG_REFERENCE_FO2,
     T.BBG_REFERENCE_FO3,
     T.BBG_REFERENCE_FO4,
     T.BBG_REFERENCE_FO5,
     T.BBG_REFERENCE_FO6,
     T.BBG_REFERENCE_FO7,
     T.BBG_REFERENCE_FO8,
     T.BBG_REFERENCE_FO9,
     T.BBG_REFERENCE_FO10)
  VALUES
    (S.PROD_DH_WID,
     S.ORG_WID,
     S.ORG_SCD1_WID,
     S.ORG_DH_WID,
     S.MN_WID,
     S.RTL_TYPE_WID,
     S.SLS_QTY,
     S.SLS_AMT_LCL,
     S.SLS_PROFIT_AMT_LCL,
     S.SLS_MANUAL_MKDN_AMT_LCL,
     S.SLS_MANUAL_MKUP_AMT_LCL,
     S.SLS_TAX_AMT_LCL,
     S.SLS_EMP_DISC_AMT_LCL,
     S.SLS_MANUAL_COUNT,
     S.SLS_SCAN_COUNT,
     S.RET_QTY,
     S.RET_AMT_LCL,
     S.RET_PROFIT_AMT_LCL,
     S.RET_MANUAL_MKDN_AMT_LCL,
     S.RET_MANUAL_MKUP_AMT_LCL,
     S.RET_TAX_AMT_LCL,
     S.RET_EMP_DISC_AMT_LCL,
     S.RET_MANUAL_COUNT,
     S.RET_SCAN_COUNT,
     S.INTEGRATION_ID,
     S.GLOBAL1_EXCHANGE_RATE,
     S.GLOBAL2_EXCHANGE_RATE,
     S.GLOBAL3_EXCHANGE_RATE,
     S.LOC_EXCHANGE_RATE,
     S.BBG_RETAIL_TYPE_WID,
     S.BBG_CUSTOMER_COUNT,
     S.BBG_SERVICE_SATISFACTION,
     S.W_INSERT_DT,
     S.W_UPDATE_DT,
     S.BBG_REFERENCE_DO1,
     S.BBG_REFERENCE_DO2,
     S.BBG_REFERENCE_DO3,
     S.BBG_REFERENCE_DO4,
     S.BBG_REFERENCE_DO5,
     S.BBG_REFERENCE_FO1,
     S.BBG_REFERENCE_FO2,
     S.BBG_REFERENCE_FO3,
     S.BBG_REFERENCE_FO4,
     S.BBG_REFERENCE_FO5,
     S.BBG_REFERENCE_FO6,
     S.BBG_REFERENCE_FO7,
     S.BBG_REFERENCE_FO8,
     S.BBG_REFERENCE_FO9,
     S.BBG_REFERENCE_FO10)
