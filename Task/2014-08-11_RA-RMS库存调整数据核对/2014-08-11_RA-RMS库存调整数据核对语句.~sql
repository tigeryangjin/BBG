--RA*********************************************************
SELECT * FROM RADM.BBG_RA_INVADJ_IT_LC_DY_F T WHERE T.INTEGRATION_ID='11-MAY-13800193576118001';
SELECT * FROM RADM.BBG_RA_INVADJ_IT_LC_DY_FS T;
SELECT * FROM RADM.BBG_RA_INVADJ_IT_LC_DY_F T WHERE T.ADJUSTMENT_REASON_WID=20001;
SELECT * FROM RADM.BBG_RA_AJUSTMENT_REASON_D;
SELECT * FROM RABATCHER.BBG_RA_INVADJ_IT_LC_DY_TMP;
SELECT * FROM RADM.W_PRODUCT_D T WHERE T.PROD_NUM='800045013';
SELECT * FROM RADM.W_INT_ORG_D T WHERE T.ORG_NUM='120173';

--RMS***********************************************************
SELECT DISTINCT T.DAY_DT FROM RMS.BBG_RA_INVADJ_IT_LC_DY_FV T;
--INV_ADJ缺少盘点数据
SELECT * FROM RMS.INV_ADJ T;
--TRAN_DATA_HISTORY,TRAN_CODE=22,GL_REF_NO=840礼品卡销售
SELECT * FROM RMS.TRAN_DATA_HISTORY@RA_RMS_DBLINK TH WHERE TH.TRAN_CODE=22 AND TH.GL_REF_NO IS NOT NULL AND TH.GL_REF_NO=840;
SELECT * FROM RADM.BBG_RA_INVADJ_IT_LC_DY_F T;
--
SELECT TH.TRAN_DATE,TH.ITEM,TH.LOCATION,TH.GL_REF_NO,COUNT(*)
FROM RMS.TRAN_DATA_HISTORY@RA_RMS_DBLINK TH
WHERE TH.TRAN_CODE=22 AND TH.GL_REF_NO IS NOT NULL
GROUP BY TH.TRAN_DATE,TH.ITEM,TH.LOCATION,TH.GL_REF_NO
HAVING COUNT(*)>1;
--RMS取数
SELECT TH.TRAN_DATE RMS_DATE,
       TH.ITEM RMS_ITEM,
       TH.LOCATION RMS_LOC,
       TH.GL_REF_NO RMS_REASON,
       SUM(TH.UNITS) RMS_ADJ_QTY,
       SUM(TH.TOTAL_COST) RMS_ADJ_COST
  FROM RMS.TRAN_DATA_HISTORY@RA_RMS_DBLINK TH
 WHERE TH.TRAN_CODE = 22
   AND TH.GL_REF_NO IS NOT NULL
 GROUP BY TH.TRAN_DATE, TH.ITEM, TH.LOCATION, TH.GL_REF_NO;
--RA取数
SELECT TO_DATE(SUBSTR(T.DT_WID, 2, 8), 'YYYYMMDD') RA_DATE,
       P.PROD_IT_NUM RA_ITEM,
       O.ORG_NUM RA_LOC,
       R.REASON RA_REASON,
       SUM(T.ADJ_QTY) RA_ADJ_QTY,
       SUM(T.ADJ_COST) RA_ADJ_COST
  FROM RADM.BBG_RA_INVADJ_IT_LC_DY_F  T,
       RABATCHER.W_PRODUCT_D_RTL_TMP  P,
       RABATCHER.W_INT_ORG_D_RTL_TMP  O,
       RADM.BBG_RA_AJUSTMENT_REASON_D R
 WHERE T.PROD_WID = P.PROD_IT_WID
   AND T.ORG_WID = O.ORG_WID
   AND T.ADJUSTMENT_REASON_WID = R.ROW_WID
 GROUP BY TO_DATE(SUBSTR(T.DT_WID, 2, 8), 'YYYYMMDD'),
          P.PROD_IT_NUM,
          O.ORG_NUM,
          R.REASON;

SELECT T.PROD_IT_NUM,COUNT(*) FROM RABATCHER.W_PRODUCT_D_RTL_TMP T GROUP BY T.PROD_IT_NUM HAVING COUNT(*)>1;
SELECT * FROM RABATCHER.W_PRODUCT_D_RTL_TMP T WHERE T.PROD_IT_NUM='100375571';

SELECT * FROM RMS.TRAN_DATA_HISTORY@RA_RMS_DBLINK TH WHERE TH.TRAN_CODE=22 AND TH.GL_REF_NO IS NOT NULL AND TH.ITEM=800003097 AND TH.LOCATION=118001 AND TH.TRAN_DATE=DATE'2013-05-25' ;
SELECT * FROM RADM.BBG_RA_INVADJ_IT_LC_DY_F T WHERE T.DT_WID=120140719000 AND T.PROD_WID=288661 AND T.ORG_WID=155 ; 
--********************************************************************
--历史数据核对
CREATE MATERIALIZED VIEW RADM.JIN_RA_RMS_INVADJ_CHECK AS
SELECT *, SYSDATE CHECK_TIME
  FROM (SELECT TO_DATE(SUBSTR(T.DT_WID, 2, 8), 'YYYYMMDD') RA_DATE,
               P.PROD_IT_NUM RA_ITEM,
               O.ORG_NUM RA_LOC,
               R.REASON RA_REASON,
               SUM(T.ADJ_QTY) RA_ADJ_QTY,
               SUM(T.ADJ_COST) RA_ADJ_COST
          FROM RADM.BBG_RA_INVADJ_IT_LC_DY_F  T,
               RABATCHER.W_PRODUCT_D_RTL_TMP  P,
               RABATCHER.W_INT_ORG_D_RTL_TMP  O,
               RADM.BBG_RA_AJUSTMENT_REASON_D R
         WHERE T.PROD_WID = P.PROD_IT_WID
           AND T.ORG_WID = O.ORG_WID
           AND T.ADJUSTMENT_REASON_WID = R.ROW_WID
         GROUP BY TO_DATE(SUBSTR(T.DT_WID, 2, 8), 'YYYYMMDD'),
                  P.PROD_IT_NUM,
                  O.ORG_NUM,
                  R.REASON) RA,
       (SELECT TH.TRAN_DATE RMS_DATE,
               TH.ITEM RMS_ITEM,
               TH.LOCATION RMS_LOC,
               TH.GL_REF_NO RMS_REASON,
               SUM(TH.UNITS) RMS_ADJ_QTY,
               SUM(TH.TOTAL_COST) RMS_ADJ_COST
          FROM RMS.TRAN_DATA_HISTORY@RA_RMS_DBLINK TH
         WHERE TH.TRAN_CODE = 22
           AND TH.GL_REF_NO IS NOT NULL
         GROUP BY TH.TRAN_DATE, TH.ITEM, TH.LOCATION, TH.GL_REF_NO) RMS
 WHERE RMS.RMS_DATE = RA.RA_DATE(+)
   AND RMS.RMS_ITEM = RA.RA_ITEM(+)
   AND RMS.RMS_LOC = RA.RA_LOC(+)
   AND RMS.RMS_REASON = RA.RA_REASON(+)
   AND (RMS.RMS_ADJ_QTY <> RA.RA_ADJ_QTY OR
       RMS.RMS_ADJ_COST <> RA.RA_ADJ_COST);

SELECT * FROM RADM.JIN_RA_RMS_INVADJ_CHECK;
DROP MATERIALIZED VIEW RADM.JIN_RA_RMS_INVADJ_CHECK;
--历史数据修复
SELECT * FROM RADM.W_PRODUCT_D T WHERE T.PROD_NUM = '100642220';
SELECT * FROM RADM.W_INT_ORG_D T WHERE T.ORG_NUM = '120027';

SELECT *
  FROM RMS.TRAN_DATA_HISTORY@RA_RMS_DBLINK TH
 WHERE TH.TRAN_CODE = 22
   AND TH.GL_REF_NO IS NOT NULL
   AND TH.ITEM = 100642220
   AND TH.LOCATION = 120027
   AND TH.TRAN_DATE = DATE '2014-04-02';
SELECT *
  FROM RADM.BBG_RA_INVADJ_IT_LC_DY_F T
 WHERE T.DT_WID = 120140402000
   AND T.PROD_WID = 888983
   AND T.ORG_WID = 39;

--库存调整数量修复
UPDATE RADM.BBG_RA_INVADJ_IT_LC_DY_F T
   SET T.ADJ_QTY =
       (SELECT C.RMS_ADJ_QTY
          FROM RADM.JIN_RA_RMS_INVADJ_CHECK   C,
               RABATCHER.W_PRODUCT_D_RTL_TMP  P,
               RABATCHER.W_INT_ORG_D_RTL_TMP  O,
               RADM.BBG_RA_AJUSTMENT_REASON_D R
         WHERE T.PROD_WID = P.PROD_IT_WID
           AND T.ORG_WID = O.ORG_WID
           AND T.ADJUSTMENT_REASON_WID = R.ROW_WID
           AND TO_DATE(SUBSTR(T.DT_WID, 2, 8), 'YYYYMMDD') = C.RA_DATE
           AND C.RA_ITEM = P.PROD_IT_NUM
           AND C.RA_LOC = O.ORG_NUM
           AND C.RA_REASON = R.REASON)
 WHERE EXISTS
 (SELECT 1
          FROM RADM.JIN_RA_RMS_INVADJ_CHECK   C,
               RABATCHER.W_PRODUCT_D_RTL_TMP  P,
               RABATCHER.W_INT_ORG_D_RTL_TMP  O,
               RADM.BBG_RA_AJUSTMENT_REASON_D R
         WHERE T.PROD_WID = P.PROD_IT_WID
           AND T.ORG_WID = O.ORG_WID
           AND T.ADJUSTMENT_REASON_WID = R.ROW_WID
           AND TO_DATE(SUBSTR(T.DT_WID, 2, 8), 'YYYYMMDD') = C.RA_DATE
           AND C.RA_ITEM = P.PROD_IT_NUM
           AND C.RA_LOC = O.ORG_NUM
           AND C.RA_REASON = R.REASON);
--库存调整成本修复
UPDATE RADM.BBG_RA_INVADJ_IT_LC_DY_F T
   SET T.ADJ_COST =
       (SELECT C.RMS_ADJ_COST
          FROM RADM.JIN_RA_RMS_INVADJ_CHECK   C,
               RABATCHER.W_PRODUCT_D_RTL_TMP  P,
               RABATCHER.W_INT_ORG_D_RTL_TMP  O,
               RADM.BBG_RA_AJUSTMENT_REASON_D R
         WHERE T.PROD_WID = P.PROD_IT_WID
           AND T.ORG_WID = O.ORG_WID
           AND T.ADJUSTMENT_REASON_WID = R.ROW_WID
           AND TO_DATE(SUBSTR(T.DT_WID, 2, 8), 'YYYYMMDD') = C.RA_DATE
           AND C.RA_ITEM = P.PROD_IT_NUM
           AND C.RA_LOC = O.ORG_NUM
           AND C.RA_REASON = R.REASON)
 WHERE EXISTS
 (SELECT 1
          FROM RADM.JIN_RA_RMS_INVADJ_CHECK   C,
               RABATCHER.W_PRODUCT_D_RTL_TMP  P,
               RABATCHER.W_INT_ORG_D_RTL_TMP  O,
               RADM.BBG_RA_AJUSTMENT_REASON_D R
         WHERE T.PROD_WID = P.PROD_IT_WID
           AND T.ORG_WID = O.ORG_WID
           AND T.ADJUSTMENT_REASON_WID = R.ROW_WID
           AND TO_DATE(SUBSTR(T.DT_WID, 2, 8), 'YYYYMMDD') = C.RA_DATE
           AND C.RA_ITEM = P.PROD_IT_NUM
           AND C.RA_LOC = O.ORG_NUM
           AND C.RA_REASON = R.REASON);
