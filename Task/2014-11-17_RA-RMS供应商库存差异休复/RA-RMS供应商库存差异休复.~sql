--RMS数据源
SELECT * FROM RMS.BBG_RA_SUPP_INV_FV_SRC@RA_RMS_DBLINK;

--RA
SELECT * FROM RADM.BBG_RA_SUPP_INV_IT_LC_DY_FV;

--BBG_RA_SUPP_INV_IT_LC_DY_F重复数据,存储过程:YJ_UPDATE_SUPP_INV_IT_LC_DY_F修复
--错误有二种：
--1:存在有二条999999999999999的记录(商品－地点－供应商)
--2:同一(商品－地点－供应商)记录，FROM_DT_WID和TO_DT_WID日期不连续

--1:未修复行数
SELECT COUNT(*)
  FROM (SELECT /*+PARALLEL(T,20)*/
         T.PROD_WID ITEM, T.ORG_SCD1_WID LOC, T.SUPPLIER_WID SUPPLIER
          FROM RADM.BBG_RA_SUPP_INV_IT_LC_DY_F T
         WHERE T.TO_DT_WID = '999999999999999'
         GROUP BY T.PROD_WID, T.ORG_SCD1_WID, T.SUPPLIER_WID
        HAVING COUNT(*) > 1);

--2:日期不连续
CREATE TABLE RADM.jin_supp_inv_fix_tmp AS
SELECT /*+PARALLEL(T,20) PARALLEL(A,20)*/
 T.ROW_WID,
 T.PROD_WID,
 T.ORG_SCD1_WID,
 T.SUPPLIER_WID,
 T.FROM_DT_WID,
 T.TO_DT_WID,
 A.NEW_TO_DT_WID
  FROM RADM.BBG_RA_SUPP_INV_IT_LC_DY_F T,
       (SELECT /*+PARALLEL(F,20)*/
         F.ROW_WID,
         '1' || TO_CHAR(LEAD(TO_DATE(SUBSTR(F.FROM_DT_WID, 2, 8), 'YYYYMMDD'))
                        OVER(PARTITION BY F.PROD_WID,
                             F.ORG_SCD1_WID,
                             F.SUPPLIER_WID ORDER BY
                             TO_DATE(SUBSTR(F.FROM_DT_WID, 2, 8), 'YYYYMMDD')) - 1,
                        'YYYYMMDD') || '000' NEW_TO_DT_WID
          FROM RADM.BBG_RA_SUPP_INV_IT_LC_DY_F F) A
 WHERE T.ROW_WID = A.ROW_WID
   AND T.TO_DT_WID <> 999999999999999
   AND T.TO_DT_WID <> A.NEW_TO_DT_WID;
	 
DROP TABLE RADM.jin_supp_inv_fix_tmp


--核对语句

SELECT /*+PARALLEL(T,20)*/
 SUM(T.SUPP_INV_QTY), SUM(T.SUPP_INV_COST)
  FROM RADM.BBG_RA_SUP_INV_IT_LC_DY_FS T
 WHERE T.DAY_DT = DATE '2014-11-16';
 
 SELECT SUM(T.SUPP_INV_QTY),SUM(T.SUPP_INV_COST) FROM RMS.BBG_RA_SUPP_INV_FV_SRC T;


SELECT * FROM RADM.BBG_RA_SUPP_INV_IT_LC_DY_F;

SELECT * FROM RMS.CMX_SUPP_INV;
SELECT * FROM RMS.CMX_SUPP_INV_HIST;

SELECT * FROM RMS.BBG_RA_SUPP_INV_FV_SRC;

--供应商库存汇总表修复
--RADM供应商库存表清单
SELECT * FROM ALL_ALL_TABLES T WHERE T.table_name LIKE '%BBG_RA_SUPP_INV%' AND T.owner='RADM';
/*
BBG_RA_SUPP_INV_CL_LC_DY_A
BBG_RA_SUPP_INV_CL_LC_MN_A
BBG_RA_SUPP_INV_DP_LC_DY_A
BBG_RA_SUPP_INV_DP_LC_MN_A
BBG_RA_SUPP_INV_IT_DY_A
BBG_RA_SUPP_INV_IT_LC_DY_F
BBG_RA_SUPP_INV_IT_LC_DY_F_GD
BBG_RA_SUPP_INV_IT_LC_G
BBG_RA_SUPP_INV_SC_DY_A
BBG_RA_SUPP_INV_SC_DY_CUR_A
BBG_RA_SUPP_INV_SC_LC_DY_A
BBG_RA_SUPP_INV_SC_LC_MN_A
BBG_RA_SUPP_INV_SC_MN_A
BBG_RA_SUPP_INV_SC_MN_CUR_A
*/
SELECT * FROM RADM.BBG_RA_SUPP_INV_IT_LC_DY_FV T WHERE T.DT_WID=120141208000;
SELECT * FROM RADM.BBG_RA_SUPP_INV_CL_LC_DY_A T WHERE T.DT_WID=120141208000;

--MERGE TABLE BBG_RA_SUPP_INV_CL_LC_DY_A
MERGE /*+APPEND*/
INTO RADM.BBG_RA_SUPP_INV_CL_LC_DY_A T
USING (SELECT P.PROD_CL_WID PROD_DH_WID,FV.ORG_WID,FV.ORG_DH_WID,FV.ORG_SCD1_WID,FV.DT_WID,FV.SUPPLIER_WID,SUM(FV.SUPP_INV_QTY) SUPP_INV_QTY,SUM(FV.SUPP_INV_COST) SUPP_INV_COST FROM RADM.BBG_RA_SUPP_INV_IT_LC_DY_FV FV,
                   RABATCHER.W_PRODUCT_D_RTL_TMP    P
        WHERE FV.PROD_WID = P.PROD_IT_WID
          AND FV.DT_WID = 120141208000) S;
					



