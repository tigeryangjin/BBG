TRUNCATE TABLE STORESALE_SEVEN;
  COMMIT;

  INSERT INTO STORESALE_SEVEN(
SELECT TRANSDATE SDATE,SHOPID,SUBSTR(CATEID,1,2)||'00' LCATE,
SUM(TRANSQTY) XL,
SUM(TRANSQTY*TRANSPRICE) XSE,
SUM(TRANSQTY*(TRANSPRICE-COSTPRICE)) ML,
SUM(CASE WHEN SUBBUSITYPE='02' THEN TRANSQTY ELSE 0 END) CXXL,
SUM(CASE WHEN SUBBUSITYPE='02' THEN TRANSQTY*TRANSPRICE ELSE 0 END) CXXS,
SUM(CASE WHEN SUBBUSITYPE='02' THEN TRANSQTY*(TRANSPRICE-COSTPRICE) ELSE 0 END) CXML,
SUM(CASE WHEN ACCTFLAG='01' THEN TRANSQTY ELSE 0 END) ZYXL,
SUM(CASE WHEN ACCTFLAG='01' THEN TRANSQTY*TRANSPRICE ELSE 0 END) ZYXS,
SUM(CASE WHEN ACCTFLAG='01' THEN TRANSQTY*(TRANSPRICE-COSTPRICE) ELSE 0 END) ZYML,
SUM(CASE WHEN SUBBUSITYPE='02' AND ACCTFLAG='01' THEN TRANSQTY ELSE 0 END) ZYCXXL,
SUM(CASE WHEN SUBBUSITYPE='02' AND ACCTFLAG='01' THEN TRANSQTY*TRANSPRICE ELSE 0 END) ZYCXXS,
SUM(CASE WHEN SUBBUSITYPE='02' AND ACCTFLAG='01' THEN TRANSQTY*(TRANSPRICE-COSTPRICE) ELSE 0 END) ZYCXML
 FROM GOODSACCT
WHERE BUSITYPE='11' AND TRANSDATE>=TO_CHAR(SYSDATE-7,'YYYYMMDD')
 GROUP BY TRANSDATE,SHOPID,SUBSTR(CATEID,1,2)||'00');
 COMMIT;
 
 
/***删除正式表近七天的销售数据***/
DELETE STORESALE_NRATE WHERE SDATE>=TO_CHAR(SYSDATE-7,'YYYYMMDD');
COMMIT;

/***往正式表中插入近七天的销售数据***/
INSERT INTO STORESALE_NRATE(
SELECT SDATE,SHOPID,LCATE,
SUM(XL) XL,SUM(XSE) XSE,SUM(ML) ML,
SUM(CXXL) CXXL,SUM(CXXS) CXXS,SUM(CXML) CXML,
SUM(ZYXL) ZYXL,SUM(ZYXS) ZYXS,SUM(ZYML) ZYML,
SUM(ZYCXXL) ZYCXXL,SUM(ZYCXXS) ZYCXXS,SUM(ZYCXML) ZYCXML
FROM 
(SELECT SDATE,SHOPID,A.LCATE,
ROUND(SUM(XL),4) XL,
ROUND(SUM(XSE/RATE),4) XSE,
ROUND(SUM(ML/RATE),4) ML,
ROUND(SUM(CXXL),4) CXXL,
ROUND(SUM(CXXS/RATE),4) CXXS,
ROUND(SUM(CXML/RATE),4) CXML,
ROUND(SUM(ZYXL),4) ZYXL,
ROUND(SUM(ZYXS/RATE),4) ZYXS,
ROUND(SUM(ZYML/RATE),4) ZYML,
ROUND(SUM(ZYCXXL),4) ZYCXXL,
ROUND(SUM(ZYCXXS/RATE),4) ZYCXXS,
ROUND(SUM(ZYCXML/RATE),4) ZYCXML 
FROM STORESALE_SEVEN A,EXECHANGE B
WHERE A.LCATE=B.LCATE
GROUP BY SDATE,SHOPID,A.LCATE)
GROUP BY SDATE,SHOPID,LCATE);
COMMIT;
