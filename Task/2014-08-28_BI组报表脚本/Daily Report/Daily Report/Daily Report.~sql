TRUNCATE TABLE STORESALE_SEVEN;
  COMMIT;

  INSERT INTO STORESALE_SEVEN(
SELECT TRANSDATE SDATE,
SHOPID,--门店编码
SUBSTR(CATEID,1,2)||'00' LCATE,--大类编号
SUM(TRANSQTY) XL,--销售数量
SUM(TRANSQTY*TRANSPRICE) XSE,--销售金额
SUM(TRANSQTY*(TRANSPRICE-COSTPRICE)) ML,--毛利
SUM(CASE WHEN SUBBUSITYPE='02' THEN TRANSQTY ELSE 0 END) CXXL,--促销销售数量
SUM(CASE WHEN SUBBUSITYPE='02' THEN TRANSQTY*TRANSPRICE ELSE 0 END) CXXS,--促销销售金额
SUM(CASE WHEN SUBBUSITYPE='02' THEN TRANSQTY*(TRANSPRICE-COSTPRICE) ELSE 0 END) CXML,--促销毛利
SUM(CASE WHEN ACCTFLAG='01' THEN TRANSQTY ELSE 0 END) ZYXL,--自营销量
SUM(CASE WHEN ACCTFLAG='01' THEN TRANSQTY*TRANSPRICE ELSE 0 END) ZYXS,--自营销售金额
SUM(CASE WHEN ACCTFLAG='01' THEN TRANSQTY*(TRANSPRICE-COSTPRICE) ELSE 0 END) ZYML,--自营毛利
SUM(CASE WHEN SUBBUSITYPE='02' AND ACCTFLAG='01' THEN TRANSQTY ELSE 0 END) ZYCXXL,--自营促销销量
SUM(CASE WHEN SUBBUSITYPE='02' AND ACCTFLAG='01' THEN TRANSQTY*TRANSPRICE ELSE 0 END) ZYCXXS,--自营促销销售金额
SUM(CASE WHEN SUBBUSITYPE='02' AND ACCTFLAG='01' THEN TRANSQTY*(TRANSPRICE-COSTPRICE) ELSE 0 END) ZYCXML--自营促销毛利
 FROM GOODSACCT
WHERE BUSITYPE='11' AND TRANSDATE>=TO_CHAR(SYSDATE-7,'YYYYMMDD')
 GROUP BY TRANSDATE,SHOPID,SUBSTR(CATEID,1,2)||'00');
 COMMIT;
 
 
--全部为未税净销售额
/***删除正式表近七天的销售数据***/
DELETE STORESALE_NRATE WHERE SDATE>=TO_CHAR(SYSDATE-7,'YYYYMMDD');
COMMIT;

/***往正式表中插入近七天的销售数据***/
INSERT INTO STORESALE_NRATE(
SELECT SDATE,SHOPID,LCATE,
SUM(XL) XL,SUM(XSE) XSE,SUM(ML) ML,
SUM(CXXL) CXXL,SUM(CXXS) CXXS,SUM(CXML) CXML,
SUM(ZYXL) ZYXL,SUM(ZYXS) ZYXS,SUM(ZYML) ZYML,
SUM(ZYCXXL) ZYCXXL,SUM(ZYCXXS) ZYCXXS,SUM(ZYCXML) ZYCXML
FROM 
(SELECT SDATE,SHOPID,A.LCATE,
ROUND(SUM(XL),4) XL,
ROUND(SUM(XSE/RATE),4) XSE,
ROUND(SUM(ML/RATE),4) ML,
ROUND(SUM(CXXL),4) CXXL,
ROUND(SUM(CXXS/RATE),4) CXXS,
ROUND(SUM(CXML/RATE),4) CXML,
ROUND(SUM(ZYXL),4) ZYXL,
ROUND(SUM(ZYXS/RATE),4) ZYXS,
ROUND(SUM(ZYML/RATE),4) ZYML,
ROUND(SUM(ZYCXXL),4) ZYCXXL,
ROUND(SUM(ZYCXXS/RATE),4) ZYCXXS,
ROUND(SUM(ZYCXML/RATE),4) ZYCXML 
FROM STORESALE_SEVEN A,EXECHANGE B
WHERE A.LCATE=B.LCATE
GROUP BY SDATE,SHOPID,A.LCATE)
GROUP BY SDATE,SHOPID,LCATE);
COMMIT;

--*********************************************************************************************************
--RA取数
--*********************************************************************************************************
--ra数据源
SELECT * FROM RADM.W_RTL_SLS_DP_LC_DY_A;
--数据脚本
SELECT TO_DATE(SUBSTR(S.DT_WID, 2, 8), 'YYYYMMDD') SDATE,
       O.ORG_NUM SHOPID,
       SUM(S.SLS_QTY - S.RET_QTY) XL,
       SUM((S.SLS_AMT_LCL - S.RET_AMT_LCL) -
           (S.SLS_TAX_AMT_LCL - S.RET_AMT_LCL)) XSE,
       SUM(S.SLS_PROFIT_AMT_LCL - S.RET_PROFIT_AMT_LCL) ML,
			 SUM(CASE WHEN R.RETAIL_GROUP_ID=5 THEN S.SLS_QTY - S.RET_QTY ELSE 0 END ) CXXL,
			 SUM(CASE WHEN R.RETAIL_GROUP_ID=5 THEN (S.SLS_AMT_LCL - S.RET_AMT_LCL) -
           (S.SLS_TAX_AMT_LCL - S.RET_AMT_LCL) ELSE 0 END) CXXS,
					 SUM(CASE WHEN R.RETAIL_GROUP_ID=5 THEN S.SLS_PROFIT_AMT_LCL - S.RET_PROFIT_AMT_LCL ELSE 0 END) CXML,
					 

  FROM RADM.W_RTL_SLS_DP_LC_DY_A     S,
       RABATCHER.W_INT_ORG_D_RTL_TMP O,
       RADM.BBG_RA_RETAIL_TYPE_D     R,
       RADM.W_PROD_CAT_DH            C
 WHERE S.ORG_WID = O.ORG_WID
   AND S.BBG_RETAIL_TYPE_WID = R.ROW_WID
   AND S.PROD_DH_WID = C.ROW_WID
   AND TO_DATE(SUBSTR(S.DT_WID, 2, 8), 'YYYYMMDD') = DATE
 '2014-08-28';
