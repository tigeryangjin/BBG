--1.按月汇总差异
SELECT SUBSTR(TO_CHAR(SD.BUSINESS_DATE, 'YYYYMMDD'), 1, 8) DAY,
       SUM(SH.VALUE) SA_AMT,
       SUM(H.JE) HY_AMT
  FROM RADM.HYXFJL@RMS_RA H,
       RADM.MDDY@RMS_RA   M,
       SA_TRAN_HEAD       SH,
       SA_STORE_DAY       SD
 WHERE SH.STORE_DAY_SEQ_NO = SD.STORE_DAY_SEQ_NO
   AND SH.STORE = SD.STORE
   AND SH.DAY = SD.DAY
   AND H.MDID = M.MDID
   AND SUBSTR(M.MDDM, 3, 6) = TO_CHAR(SH.STORE)
   AND H.JLBH = SH.TRAN_NO
   AND H.SKTNO = SH.REGISTER
   AND H.JZRQ = SD.BUSINESS_DATE
   AND SD.BUSINESS_DATE BETWEEN DATE '2014-01-01' AND DATE
 '2014-12-31'
 GROUP BY SUBSTR(TO_CHAR(SD.BUSINESS_DATE, 'YYYYMMDD'), 1, 8)
 ORDER BY SUBSTR(TO_CHAR(SD.BUSINESS_DATE, 'YYYYMMDD'), 1, 8);

--2.差异明细
SELECT SD.BUSINESS_DATE,
       SH.STORE,
       SH.REGISTER,
       SH.TRAN_NO,
       SH.VALUE SA_AMT,
       H.JE HY_AMT,
       SH.VALUE - H.JE DIFF
  FROM RADM.HYXFJL@RMS_RA H,
       RADM.MDDY@RMS_RA   M,
       SA_TRAN_HEAD       SH,
       SA_STORE_DAY       SD
 WHERE SH.STORE_DAY_SEQ_NO = SD.STORE_DAY_SEQ_NO
   AND SH.STORE = SD.STORE
   AND SH.DAY = SD.DAY
   AND H.MDID = M.MDID
   AND SUBSTR(M.MDDM, 3, 6) = TO_CHAR(SH.STORE)
   AND H.JLBH = SH.TRAN_NO
   AND H.SKTNO = SH.REGISTER
   AND H.JZRQ = SD.BUSINESS_DATE
   AND SD.BUSINESS_DATE = DATE '2014-11-28'
   AND SH.VALUE <> H.JE
 ORDER BY ABS(SH.VALUE - H.JE) DESC;

--3.CRM不在RMS中的
SELECT H.JZRQ, M.MDDM, H.SKTNO, H.JLBH, H.JE
  FROM RADM.HYXFJL@RMS_RA H, RADM.MDDY@RMS_RA M
 WHERE H.MDID = M.MDID
   AND M.SHDM = 'CS'
   AND H.JZRQ = DATE '2014-06-01'
   AND NOT EXISTS
 (SELECT 1
          FROM SA_TRAN_HEAD SH, SA_STORE_DAY SD
         WHERE SH.STORE_DAY_SEQ_NO = SD.STORE_DAY_SEQ_NO
           AND SH.STORE = SD.STORE
           AND SH.DAY = SD.DAY
           AND SUBSTR(M.MDDM, 3, 6) = TO_CHAR(SH.STORE)
           AND H.JLBH = SH.TRAN_NO
           AND H.SKTNO = SH.REGISTER
              --AND H.JZRQ = SD.BUSINESS_DATE
           AND SD.BUSINESS_DATE BETWEEN DATE '2014-05-30' AND DATE
         '2014-06-05');
