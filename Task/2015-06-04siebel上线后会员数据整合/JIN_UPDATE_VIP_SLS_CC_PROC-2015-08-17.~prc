CREATE OR REPLACE PROCEDURE JIN_UPDATE_VIP_SLS_CC_PROC(DTWID INT) AS

  CNT INT;

BEGIN
  --CREATE BAK TABLE
  BEGIN
    BEGIN
      EXECUTE IMMEDIATE 'TRUNCATE TABLE RADM.W_RTL_SLS_TRX_IT_LC_DY_F_BAK';
      INSERT /*+PARALLEL(16)*/
      INTO RADM.W_RTL_SLS_TRX_IT_LC_DY_F_BAK
        SELECT * FROM RADM.W_RTL_SLS_TRX_IT_LC_DY_F WHERE DT_WID = DTWID;
      COMMIT;
    END;
  
    --5.1.BBG_RA_CUST_SC_LC_DY_A
    BEGIN
      EXECUTE IMMEDIATE 'ALTER TABLE RADM.BBG_RA_CUST_SC_LC_DY_A NOLOGGING';
      EXECUTE IMMEDIATE 'ALTER SESSION ENABLE PARALLEL DML';
      SELECT COUNT(1)
        INTO CNT
        FROM ALL_ALL_TABLES
       WHERE TABLE_NAME = 'CUST_TMP1';
      IF CNT = 1 THEN
        EXECUTE IMMEDIATE 'DROP TABLE RADM.CUST_TMP1';
      END IF;
      EXECUTE IMMEDIATE 'CREATE TABLE RADM.CUST_TMP1 AS
SELECT C.PROD_SC_WID PROD_DH_WID, B.ORG_WID, B.DT_WID, COUNT(DISTINCT B.SLS_TRX_ID) CNT
  FROM RADM.W_RTL_SLS_TRX_IT_LC_DY_F_BAK B, RABATCHER.W_PRODUCT_D_RTL_TMP C
 WHERE B.PROD_WID = C.PROD_IT_WID
 GROUP BY C.PROD_SC_WID, B.ORG_WID, B.DT_WID';
      EXECUTE IMMEDIATE 'CREATE UNIQUE INDEX PK_CUST_TMP1 ON CUST_TMP1(PROD_DH_WID,
                                            ORG_WID,
                                            DT_WID)';
      UPDATE RADM.BBG_RA_CUST_SC_LC_DY_A A
         SET A.VIP_BBG_CUSTOMER_COUNT = NVL((SELECT D.CNT
                                              FROM CUST_TMP1 D
                                             WHERE D.PROD_DH_WID =
                                                   A.PROD_DH_WID
                                               AND D.ORG_WID = A.ORG_WID
                                               AND D.DT_WID = A.DT_WID),
                                            0)
       WHERE EXISTS (SELECT 1
                FROM CUST_TMP1 D
               WHERE D.PROD_DH_WID = A.PROD_DH_WID
                 AND D.ORG_WID = A.ORG_WID
                 AND D.DT_WID = A.DT_WID)
         AND A.VIP_BBG_CUSTOMER_COUNT IS NULL;
      COMMIT;
    
      EXECUTE IMMEDIATE 'ALTER TABLE RADM.BBG_RA_CUST_SC_LC_DY_A LOGGING';
    END;
    --5.2.BBG_RA_CUST_SC_LC_DY_HR_A
    BEGIN
      EXECUTE IMMEDIATE 'ALTER TABLE RADM.BBG_RA_CUST_SC_LC_DY_HR_A NOLOGGING';
      EXECUTE IMMEDIATE 'ALTER SESSION ENABLE PARALLEL DML';
      SELECT COUNT(1)
        INTO CNT
        FROM ALL_ALL_TABLES
       WHERE TABLE_NAME = 'CUST_TMP2';
      IF CNT = 1 THEN
        EXECUTE IMMEDIATE 'DROP TABLE RADM.CUST_TMP2';
      END IF;
      EXECUTE IMMEDIATE '';
      EXECUTE IMMEDIATE '';
    
      EXECUTE IMMEDIATE 'ALTER TABLE RADM.BBG_RA_CUST_SC_LC_DY_HR_A LOGGING';
    END;
    --5.3.BBG_RA_CUST_CL_LC_DY_A
    BEGIN
      EXECUTE IMMEDIATE 'ALTER TABLE RADM.BBG_RA_CUST_CL_LC_DY_A NOLOGGING';
      EXECUTE IMMEDIATE 'ALTER SESSION ENABLE PARALLEL DML';
      SELECT COUNT(1)
        INTO CNT
        FROM ALL_ALL_TABLES
       WHERE TABLE_NAME = 'CUST_TMP3';
      IF CNT = 1 THEN
        EXECUTE IMMEDIATE 'DROP TABLE RADM.CUST_TMP3';
      END IF;
      EXECUTE IMMEDIATE '';
      EXECUTE IMMEDIATE '';
    
      EXECUTE IMMEDIATE 'ALTER TABLE RADM.BBG_RA_CUST_CL_LC_DY_A LOGGING';
    END;
    --5.4.BBG_RA_CUST_CL_LC_DY_HR_A
    BEGIN
      EXECUTE IMMEDIATE 'ALTER TABLE RADM.BBG_RA_CUST_CL_LC_DY_HR_A NOLOGGING';
      EXECUTE IMMEDIATE 'ALTER SESSION ENABLE PARALLEL DML';
      SELECT COUNT(1)
        INTO CNT
        FROM ALL_ALL_TABLES
       WHERE TABLE_NAME = 'CUST_TMP4';
      IF CNT = 1 THEN
        EXECUTE IMMEDIATE 'DROP TABLE RADM.CUST_TMP4';
      END IF;
      EXECUTE IMMEDIATE '';
      EXECUTE IMMEDIATE '';
    
      EXECUTE IMMEDIATE 'ALTER TABLE RADM.BBG_RA_CUST_CL_LC_DY_HR_A LOGGING';
    END;
    --5.5.BBG_RA_CUST_DP_LC_DY_A
    BEGIN
      EXECUTE IMMEDIATE 'ALTER TABLE RADM.BBG_RA_CUST_DP_LC_DY_A NOLOGGING';
      EXECUTE IMMEDIATE 'ALTER SESSION ENABLE PARALLEL DML';
      SELECT COUNT(1)
        INTO CNT
        FROM ALL_ALL_TABLES
       WHERE TABLE_NAME = 'CUST_TMP5';
      IF CNT = 1 THEN
        EXECUTE IMMEDIATE 'DROP TABLE RADM.CUST_TMP5';
      END IF;
      EXECUTE IMMEDIATE '';
      EXECUTE IMMEDIATE '';
    
      EXECUTE IMMEDIATE 'ALTER TABLE RADM.BBG_RA_CUST_DP_LC_DY_A LOGGING';
    END;
    --5.6.BBG_RA_CUST_DP_LC_DY_HR_A
    BEGIN
      EXECUTE IMMEDIATE 'ALTER TABLE RADM.BBG_RA_CUST_DP_LC_DY_HR_A NOLOGGING';
      EXECUTE IMMEDIATE 'ALTER SESSION ENABLE PARALLEL DML';
      SELECT COUNT(1)
        INTO CNT
        FROM ALL_ALL_TABLES
       WHERE TABLE_NAME = 'CUST_TMP6';
      IF CNT = 1 THEN
        EXECUTE IMMEDIATE 'DROP TABLE RADM.CUST_TMP6';
      END IF;
      EXECUTE IMMEDIATE '';
      EXECUTE IMMEDIATE '';
    
      EXECUTE IMMEDIATE 'ALTER TABLE RADM.BBG_RA_CUST_DP_LC_DY_HR_A LOGGING';
    END;
    --5.7.BBG_RA_CUST_LC_DY_A
    BEGIN
      EXECUTE IMMEDIATE 'ALTER TABLE RADM.BBG_RA_CUST_LC_DY_A NOLOGGING';
      EXECUTE IMMEDIATE 'ALTER SESSION ENABLE PARALLEL DML';
      SELECT COUNT(1)
        INTO CNT
        FROM ALL_ALL_TABLES
       WHERE TABLE_NAME = 'CUST_TMP7';
      IF CNT = 1 THEN
        EXECUTE IMMEDIATE 'DROP TABLE RADM.CUST_TMP7';
      END IF;
      EXECUTE IMMEDIATE '';
      EXECUTE IMMEDIATE '';
    
      EXECUTE IMMEDIATE 'ALTER TABLE RADM.BBG_RA_CUST_LC_DY_A LOGGING';
    END;
    --5.8.BBG_RA_CUST_LC_DY_HR_A
    BEGIN
      EXECUTE IMMEDIATE 'ALTER TABLE RADM.BBG_RA_CUST_LC_DY_HR_A NOLOGGING';
      EXECUTE IMMEDIATE 'ALTER SESSION ENABLE PARALLEL DML';
      SELECT COUNT(1)
        INTO CNT
        FROM ALL_ALL_TABLES
       WHERE TABLE_NAME = 'CUST_TMP8';
      IF CNT = 1 THEN
        EXECUTE IMMEDIATE 'DROP TABLE RADM.CUST_TMP8';
      END IF;
      EXECUTE IMMEDIATE '';
      EXECUTE IMMEDIATE '';
    
      EXECUTE IMMEDIATE 'ALTER TABLE RADM.BBG_RA_CUST_LC_DY_HR_A LOGGING';
    END;
  
  END;

END;
/
