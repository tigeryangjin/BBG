--W_PRODUCT_D_TL无记录
100620830
100620928
100622739
100629367
100629383
100629463
100629498
100630641
100630667
;

SELECT * FROM W_PRODUCT_D T WHERE T.PROD_NUM='100620830';
SELECT * FROM W_PRODUCT_ATTR_D T WHERE T.PROD_NUM='100620830';
SELECT * FROM W_PRODUCT_D_TL T WHERE T.Integration_Id IN ('100620830',
'100620928',
'100622739',
'100629367',
'100629383',
'100629463',
'100629498',
'100630641',
'100630667');

100129063
;
SELECT * FROM W_PRODUCT_D T WHERE T.PROD_NUM='100129063';
SELECT * FROM W_PRODUCT_ATTR_D T WHERE T.PROD_NUM='100129063';
SELECT * FROM W_PRODUCT_D_TL T WHERE T.Integration_Id='100129063';

SELECT * FROM RABATCHER.W_PRODUCT_D_RTL_TMP T WHERE T.PROD_IT_NUM='100620830';
--W_PRODUCT_DS_TL_V->W_PRODUCT_D_TL
SELECT * FROM W_PRODUCT_DS_TL_V T;
SELECT * FROM W_PRODUCT_DS_TL;

--商品编码
SELECT T.PROD_NUM
   FROM W_PRODUCT_D T,
	      W_PRODUCT_ATTR_D A
	WHERE T.SCD1_WID = A.SCD1_WID
   AND A.PRODUCT_ATTR12_NAME = A.PRODUCT_ATTR11_NAME;
	 
--查找不存在	 W_PRODUCT_D_TL表中的商品编码,244206行
SELECT T.PROD_NUM
   FROM W_PRODUCT_D T,
	      W_PRODUCT_ATTR_D A
	WHERE T.SCD1_WID = A.SCD1_WID
   AND A.PRODUCT_ATTR12_NAME = A.PRODUCT_ATTR11_NAME
	 AND T.PROD_NUM NOT IN (SELECT T.INTEGRATION_ID FROM W_PRODUCT_DS_TL T );
	 
SELECT COUNT(*) from W_PRODUCT_D;
SELECT COUNT(*) FROM W_PRODUCT_ATTR_D;
SELECT COUNT(*) from W_PRODUCT_D_TL;

--清除W_PRODUCT_DS
TRUNCATE TABLE RADM.W_PRODUCT_DS;

TRUNCATE TABLE RADM.C_LOAD_DATES;
----------------------------------------------------------------------------------------------------------------
--插入W_PRODUCT_DS中间表之后，执行SIL_ItemDimension
INSERT INTO W_PRODUCT_DS
(PRODUCT_TYPE_CODE,UOM_CODE,SRC_EFF_FROM_DT,DATASOURCE_NUM_ID,INTEGRATION_ID,PROD_CAT5,PACK_FLG,PROD_CAT5_AS_WAS,PROD_NUM,BBG_ITEM_BRAND,BBG_ITEM_UOM_DESC)
SELECT ITEM.ITEM_NUMBER_TYPE,ITEM.STANDARD_UOM,DATE '2013-12-09',1 /*DATASOURCE_NUM_ID*/,
ITEM.ITEM,DIVISION.DIVISION|| '~'||GROUPS.GROUP_NO||'~' ||ITEM.DEPT||'~'||ITEM.CLASS|| '~'||ITEM.SUBCLASS, /*PROD_CAT5*/
ITEM.PACK_IND,/*PACK_FLG*/
DIVISION.DIVISION||'~'||GROUPS.GROUP_NO|| '~'||ITEM.DEPT||'~' ||ITEM.CLASS||'~'||ITEM.SUBCLASS, /*PROD_CAT5_AS_WAS*/
ITEM.ITEM /*PROD_NUM*/,
BBG_RA_ITEM_CUSTOM_V.BBG_ITEM_BRAND /*BBG_ITEM_BRAND*/,
UOM_CLASS.UOM_DESC /*BBG_ITEM_UOM_DESC*/
FROM ITEM_MASTER@RA_RMS_DBLINK ITEM,
     DIVISION@RA_RMS_DBLINK DIVISION,
     GROUPS@RA_RMS_DBLINK GROUPS ,
     BBG_RA_ITEM_CUSTOM_V@RA_RMS_DBLINK BBG_RA_ITEM_CUSTOM_V,
     UOM_CLASS@RA_RMS_DBLINK UOM_CLASS,
     DEPS@RA_RMS_DBLINK DEPS
WHERE GROUPS.DIVISION=DIVISION.DIVISION
 AND ITEM.STANDARD_UOM=UOM_CLASS.UOM
 AND DEPS.GROUP_NO=GROUPS.GROUP_NO
 AND ITEM.DEPT=DEPS.DEPT
 AND ITEM.ITEM=BBG_RA_ITEM_CUSTOM_V.ITEM
 AND ITEM.STATUS= 'A'
/* AND (ITEM.PACK_IND='N' OR (ITEM.PACK_IND='Y' AND NOT EXISTS (SELECT 'X'
            FROM QUALIFY(V_PACKSKU_QTY) V_PACKSKU1,QUALIFY(ITEM_MASTER) IM1
            WHERE V_PACKSKU1.PACK_NO = ITEM.ITEM
            AND V_PACKSKU1.ITEM = IM1.ITEM
            AND IM1.ITEM_XFORM_IND = 'Y'
            AND ROWNUM = 1)))*/
 AND ITEM.ITEM_XFORM_IND!= 'Y'
 AND ITEM.ITEM IN (SELECT T.PROD_NUM
   FROM W_PRODUCT_D T,
	      W_PRODUCT_ATTR_D A
	WHERE T.SCD1_WID = A.SCD1_WID
   AND A.PRODUCT_ATTR12_NAME = A.PRODUCT_ATTR11_NAME
	 AND T.PROD_NUM NOT IN (SELECT T.INTEGRATION_ID FROM W_PRODUCT_DS_TL T ));
-- AND NOT EXISTS (SELECT 1 FROM W_PRODUCT_D T WHERE T.PROD_NUM=ITEM.ITEM AND T.PROD_NUM LIKE '100622%' );

SELECT * FROM RADM.W_PRODUCT_D_TL;
---------------------------------------------------------------------------------------------------------------------------

/* SCD Inserts*/
insert into	RADM.W_PRODUCT_D_TL
(
	PRODUCT_NAME,
	PRODUCT_DESCR,
	LANGUAGE_CODE,
	SRC_LANGUAGE_CODE,
	INTEGRATION_ID,
	DATASOURCE_NUM_ID
	,ROW_WID,
	W_INSERT_DT,
	W_UPDATE_DT,
	ETL_PROC_WID
)
select	PRODUCT_NAME,
	PRODUCT_DESCR,
	LANGUAGE_CODE,
	SRC_LANGUAGE_CODE,
	INTEGRATION_ID,
	DATASOURCE_NUM_ID  
	,RADM.W_PRODUCT_D_TL_SEQ.NEXTVAL,
	SYSDATE,
	SYSDATE,
	100--#RA_BI.ETL_PROC_WID  
from	(
		select	IM.ITEM_DESC PRODUCT_NAME,
		        NULL PRODUCT_DESCR,
						'ZHS' LANGUAGE_CODE,
						'US' SRC_LANGUAGE_CODE,
						IM.ITEM INTEGRATION_ID,
						1	DATASOURCE_NUM_ID	 
		from	ITEM_MASTER@RA_RMS_DBLINK IM
		where	(1=1)
UNION ALL
		select	IM.ITEM_DESC PRODUCT_NAME,
		        NULL PORDUCT_DESCR,
						'US' LANGUAGE_CODE,
						'US' SRC_LANGGUAGE_CODE,
						IM.ITEM INTEGRATION_ID,
						1	DATASOURCE_NUM_ID	 
		from	ITEM_MASTER@RA_RMS_DBLINK IM
		where	(1=1)
	) S
where not exists (
     select 'X'
     from   RADM.W_PRODUCT_D_TL T
     where  T.LANGUAGE_CODE	= S.LANGUAGE_CODE
and	T.INTEGRATION_ID	= S.INTEGRATION_ID
and	T.DATASOURCE_NUM_ID	= S.DATASOURCE_NUM_ID
)
/*AND S.INTEGRATION_ID IN (SELECT T.PROD_NUM
   FROM W_PRODUCT_D T,
	      W_PRODUCT_ATTR_D A
	WHERE T.SCD1_WID = A.SCD1_WID
   AND A.PRODUCT_ATTR12_NAME = A.PRODUCT_ATTR11_NAME
	 AND T.PROD_NUM NOT IN (SELECT T.INTEGRATION_ID FROM W_PRODUCT_DS_TL T ))*/;
