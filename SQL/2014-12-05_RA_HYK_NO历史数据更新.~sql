--创建TRAN_SEQ_NO和HYK_NO对应记录临时表
CREATE TABLE RADM.JIN_SLS_TRX_HYKNO_TMP AS
SELECT /*+PARALLEL(T,20)*/
DISTINCT T.TRAN_SEQ_NO, T.REF_NO27
  FROM RMS.SA_TRAN_HEAD@RA_RMS_DBLINK T
 WHERE T.REF_NO27 IS NOT NULL;
 
--检查临时表一张小票是否有二个会员卡情况
SELECT COUNT(*) FROM RADM.JIN_SLS_TRX_HYKNO_TMP;
SELECT /*+PARALLEL(T,20)*/ T.TRAN_SEQ_NO, COUNT(T.REF_NO27)
  FROM RADM.JIN_SLS_TRX_HYKNO_TMP T
 GROUP BY T.TRAN_SEQ_NO
HAVING COUNT(T.REF_NO27) > 1;

--更新W_RTL_SLS_TRX_IT_LC_DY_F表HYK_NO字段
UPDATE /*+PARALLEL(F,20)*/ RADM.W_RTL_SLS_TRX_IT_LC_DY_F F
   SET F.HYK_NO =
       (SELECT /*+PARALLEL(H,20)*/
         H.REF_NO27
          FROM RADM.JIN_SLS_TRX_HYKNO_TMP H
         WHERE TRIM(F.SLS_TRX_ID) = H.TRAN_SEQ_NO)
 WHERE EXISTS (SELECT /*+PARALLEL(X,20)*/
         1
          FROM RADM.JIN_SLS_TRX_HYKNO_TMP X
         WHERE TRIM(F.SLS_TRX_ID) = X.TRAN_SEQ_NO)
   AND F.HYK_NO IS NULL
   AND F.DT_WID = 120141006000;
COMMIT;


