--销售物化视图
CREATE MATERIALIZED VIEW RADM.YJ_SLS_IT_LC_MN_V
AS
SELECT T.ORG_WID,T.PROD_WID,SUM((T.SLS_AMT_LCL-T.RET_AMT_LCL)-(T.SLS_TAX_AMT_LCL-T.RET_TAX_AMT_LCL)) SLS_AMT
FROM W_RTL_SLS_IT_LC_DY_A T
WHERE T.DT_WID BETWEEN '120131101000' AND '120131231000'
GROUP BY T.ORG_WID,T.PROD_WID;

DROP MATERIALIZED VIEW RADM.YJ_SLS_IT_LC_MN_V;
--库存物化视图
CREATE MATERIALIZED VIEW RADM.YJ_SOH_COST_AVG_V
AS
SELECT T.ORG_WID,T.PROD_WID,SUM(T.INV_SOH_QTY) INV_SOH_QTY,SUM(T.INV_SOH_COST_AMT_LCL) INV_SOH_COST
  FROM W_RTL_INV_IT_LC_DY_FV T 
 WHERE T.DT_WID = '120131231000'
 GROUP BY T.ORG_WID,T.PROD_WID;
 
 DROP MATERIALIZED VIEW RADM.YJ_SOH_COST_AVG_V;
 
--有库存无销售(12.31有库存,11,12月无销售)
SELECT ORG.ORG_NUM,
			 ORG_NAME.ORG_NAME,
			 DH.LVL4ANC_PRODCAT_ID,
			 D2.C1,
			 PROD_NUM.PROD_NUM,
			 PROD_NAME.PRODUCT_NAME,
			 NOWINV.INV_SOH_QTY,
			 NOWINV.INV_SOH_COST_AMT_LCL
	FROM --INV
				YJ_SOH_COST_AVG_V     INV,
			 W_RTL_INV_IT_LC_DY_FV NOWINV,
			 --SLS
			 YJ_SLS_IT_LC_MN_V SLS,
			 W_INT_ORG_D       ORG,
			 W_PROD_CAT_DH     DH
 inner join (select T16687.DOMAIN_MEMBER_NAME as c1,
										T16687.DOMAIN_MEMBER_CODE as c2,
										T16687.DATASOURCE_NUM_ID  as c3
							 from W_DOMAIN_MEMBER_LKP_TL T16687 /* Lookup_W_DOMAIN_MEMBER_LKP_TL */
							where (T16687.DOMAIN_CODE = 'MCAT' and
										T16687.DOMAIN_TYPE_CODE = 'S' and
										T16687.LANGUAGE_CODE = 'ZHS')) D2
		On concat(concat(concat(concat(concat(concat('SBC', '~'),
																					DH.LVL6ANC_PRODCAT_ID),
																	 '~'),
														DH.LVL5ANC_PRODCAT_ID),
										 '~'),
							DH.LVL4ANC_PRODCAT_ID) = D2.c2
	 and DH.DATASOURCE_NUM_ID = D2.c3,
--W_INT_ORG_DH ORGDH,

--商品编码
 (SELECT T.*
					FROM W_PRODUCT_D T, W_PRODUCT_ATTR_D A
				 WHERE T.SCD1_WID = A.SCD1_WID
					 AND A.PRODUCT_ATTR12_NAME = A.PRODUCT_ATTR11_NAME)
 PROD_NUM,
--商品名称
 (SELECT DATASOURCE_NUM_ID, INTEGRATION_ID, PRODUCT_NAME
					FROM W_PRODUCT_D_TL
				 WHERE LANGUAGE_CODE = 'ZHS') PROD_NAME,
--网点名称
 (SELECT DATASOURCE_NUM_ID,
							 INTEGRATION_ID,
							 ORG_DESCR,
							 ORG_NAME,
							 LANGUAGE_CODE
					FROM W_INT_ORG_D_TL
				 WHERE LANGUAGE_CODE = 'ZHS') ORG_NAME
 WHERE INV.PROD_WID = PROD_NUM.ROW_WID
	 AND INV.ORG_WID = ORG.ROW_WID
	 AND NOWINV.PROD_WID = PROD_NUM.ROW_WID
	 AND NOWINV.ORG_WID = ORG.ROW_WID
	 AND NOWINV.DT_WID = '120130901000'
	 AND NOWINV.INV_SOH_QTY > 0 --有库存
	 AND SLS.PROD_WID = PROD_NUM.ROW_WID
	 AND SLS.ORG_WID = ORG.ROW_WID
	 AND SLS.SLS_AMT = 0 --无销售
	 AND PROD_NUM.DATASOURCE_NUM_ID = PROD_NAME.DATASOURCE_NUM_ID
	 AND PROD_NUM.INTEGRATION_ID = PROD_NAME.INTEGRATION_ID
	 AND ORG_NAME.INTEGRATION_ID = ORG.INTEGRATION_ID
	 AND ORG_NAME.DATASOURCE_NUM_ID = ORG.DATASOURCE_NUM_ID
	 AND PROD_NUM.PROD_CAT5_WID_AS_WAS = DH.ROW_WID
--ORDER BY ORG.ORG_NUM,DH.LVL4ANC_PRODCAT_ID,PROD_NUM.PROD_NUM 
--GROUP BY DH.LVL5ANC_PRODCAT_ID,D2.C1,PROD_NUM.PROD_NUM,PROD_NAME.PRODUCT_NAME,ORG.ORG_NUM,ORG_NAME.ORG_NAME
;
