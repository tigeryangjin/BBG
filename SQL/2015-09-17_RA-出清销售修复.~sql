--2015-09-15，16二天的销售数据，出清销售有问题，RA销售数据需要修复。
--删除RA销售数据，重新插入销售数据。

--1.删除RA销售
CALL BBG_RA_DEL_SLS_DT(120150915000);
CALL BBG_RA_DEL_SLS_DT(120150916000);
--2.备份销售数据
SELECT * FROM RA_RMS.BBG_XTERN_RDWT;
SELECT * FROM RA_RMS.XTERN_RDWT;

CREATE TABLE RA_RMS.BBG_XTERN_RDWT_2015091516 AS
SELECT * FROM RA_RMS.XTERN_RDWT;


--3.BBG_XTERN_RDWT
TRUNCATE TABLE RA_RMS.BBG_XTERN_RDWT;

insert into RA_RMS.BBG_XTERN_RDWT T
  (BUSINESS_DT,
   TRANSACTION_DT,
   LOCATION,
   REGISTER_ID,
   BANNER_ID,
   LINE_MEDIA_ID,
   SELLING_ITEM_ID,
   CUST_ORDER_HEADER_ID,
   CUST_ORDER_LINE_ID,
   CUST_ORDER_CREATE_DT,
   CASHIER_IDENT,
   SALES_PERSON_IDENT,
   CUST_ID_TYPE,
   CUST_ID_NO,
   TRANSACTION_NO,
   ORIG_REGISTER_ID,
   ORIG_TRANSACTION_NO,
   TRANSACTION_HEADER_NO,
   REVISION_NO,
   SALES_SIGN,
   TRANSACTION_TYPE,
   SUB_TRANSACTION_TYPE,
   RETAIL_TYPE,
   ITEM_SEQ_NO,
   EMPLOYEE_NO,
   RECEIPT_IND,
   REASON_CD,
   VENDOR_NO,
   ITEM_TYPE,
   ITEM,
   REF_ITEM,
   TAXABLE_IND,
   ENTRY_MODE,
   DEPARTMENT,
   CLASS,
   SUBCLASS,
   TOT_SALES_QUANTITY,
   TOT_TRANSACTION_VAL,
   OVERRIDE_REASON,
   RETURN_REASON,
   TOT_ORIG_SIGN,
   TOT_ORIG_SALES_VAL,
   WEATHER,
   TEMPERATURE,
   TRAFFIC,
   CONSTRUCTION,
   DROP_SHIPMENT_IND,
   DISCOUNT_TYPE,
   PROMO_TRANSACTION_TYPE,
   PROMO_NO,
   PROMO_COMPONENT_NO,
   COUPON_NO,
   COUPON_REF_NO,
   SALES_QUANTITY,
   TRANSACTION_SIGN,
   TRANSACTION_VAL,
   DISCOUNT_VAL,
   UNIT_RETAIL,
   W_INSERT_DT)
  select S.BUSINESS_DT,
         S.TRANSACTION_DT,
         S.LOCATION,
         S.REGISTER_ID,
         S.BANNER_ID,
         S.LINE_MEDIA_ID,
         S.SELLING_ITEM_ID,
         S.CUST_ORDER_HEADER_ID,
         S.CUST_ORDER_LINE_ID,
         S.CUST_ORDER_CREATE_DT,
         S.CASHIER_IDENT,
         S.SALES_PERSON_IDENT,
         S.CUST_ID_TYPE,
         S.CUST_ID_NO,
         S.TRANSACTION_NO,
         S.ORIG_REGISTER_ID,
         S.ORIG_TRANSACTION_NO,
         S.TRANSACTION_HEADER_NO,
         S.REVISION_NO,
         S.SALES_SIGN,
         S.TRANSACTION_TYPE,
         S.SUB_TRANSACTION_TYPE,
         S.RETAIL_TYPE,
         S.ITEM_SEQ_NO,
         S.EMPLOYEE_NO,
         S.RECEIPT_IND,
         S.REASON_CD,
         S.VENDOR_NO,
         S.ITEM_TYPE,
         S.ITEM,
         S.REF_ITEM,
         S.TAXABLE_IND,
         S.ENTRY_MODE,
         S.DEPARTMENT,
         S.CLASS,
         S.SUBCLASS,
         S.TOT_SALES_QUANTITY,
         S.TOT_TRANSACTION_VAL,
         S.OVERRIDE_REASON,
         S.RETURN_REASON,
         S.TOT_ORIG_SIGN,
         S.TOT_ORIG_SALES_VAL,
         S.WEATHER,
         S.TEMPERATURE,
         S.TRAFFIC,
         S.CONSTRUCTION,
         S.DROP_SHIPMENT_IND,
         S.DISCOUNT_TYPE,
         S.PROMO_TRANSACTION_TYPE,
         S.PROMO_NO,
         S.PROMO_COMPONENT_NO,
         S.COUPON_NO,
         S.COUPON_REF_NO,
         S.SALES_QUANTITY,
         S.TRANSACTION_SIGN,
         S.TRANSACTION_VAL,
         S.DISCOUNT_VAL,
         S.UNIT_RETAIL,
         SYSDATE
    from (select TRIM(XTERN_RDWT.BUSINESS_DT) BUSINESS_DT,
                 TRIM(XTERN_RDWT.TRANSACTION_DT) TRANSACTION_DT,
                 TRIM(XTERN_RDWT.LOCATION) LOCATION,
                 TRIM(XTERN_RDWT.REGISTER_ID) REGISTER_ID,
                 TRIM(XTERN_RDWT.BANNER_ID) BANNER_ID,
                 TRIM(XTERN_RDWT.LINE_MEDIA_ID) LINE_MEDIA_ID,
                 TRIM(XTERN_RDWT.SELLING_ITEM_ID) SELLING_ITEM_ID,
                 TRIM(XTERN_RDWT.CUST_ORDER_HEADER_ID) CUST_ORDER_HEADER_ID,
                 TRIM(XTERN_RDWT.CUST_ORDER_LINE_ID) CUST_ORDER_LINE_ID,
                 TRIM(XTERN_RDWT.CUST_ORDER_CREATE_DT) CUST_ORDER_CREATE_DT,
                 TRIM(XTERN_RDWT.CASHIER_IDENT) CASHIER_IDENT,
                 TRIM(XTERN_RDWT.SALES_PERSON_IDENT) SALES_PERSON_IDENT,
                 TRIM(XTERN_RDWT.CUST_ID_TYPE) CUST_ID_TYPE,
                 TRIM(XTERN_RDWT.CUST_ID_NO) CUST_ID_NO,
                 TRIM(XTERN_RDWT.TRANSACTION_NO) TRANSACTION_NO,
                 TRIM(XTERN_RDWT.ORIG_REGISTER_ID) ORIG_REGISTER_ID,
                 TRIM(XTERN_RDWT.ORIG_TRANSACTION_NO) ORIG_TRANSACTION_NO,
                 TRIM(XTERN_RDWT.TRANSACTION_HEADER_NO) TRANSACTION_HEADER_NO,
                 TRIM(XTERN_RDWT.REVISION_NO) REVISION_NO,
                 TRIM(XTERN_RDWT.SALES_SIGN) SALES_SIGN,
                 TRIM(XTERN_RDWT.TRANSACTION_TYPE) TRANSACTION_TYPE,
                 TRIM(XTERN_RDWT.SUB_TRANSACTION_TYPE) SUB_TRANSACTION_TYPE,
                 TRIM(XTERN_RDWT.RETAIL_TYPE) RETAIL_TYPE,
                 TRIM(XTERN_RDWT.ITEM_SEQ_NO) ITEM_SEQ_NO,
                 TRIM(XTERN_RDWT.EMPLOYEE_NO) EMPLOYEE_NO,
                 TRIM(XTERN_RDWT.RECEIPT_IND) RECEIPT_IND,
                 TRIM(XTERN_RDWT.REASON_CD) REASON_CD,
                 TRIM(XTERN_RDWT.VENDOR_NO) VENDOR_NO,
                 TRIM(XTERN_RDWT.ITEM_TYPE) ITEM_TYPE,
                 TRIM(XTERN_RDWT.ITEM) ITEM,
                 TRIM(XTERN_RDWT.REF_ITEM) REF_ITEM,
                 TRIM(XTERN_RDWT.TAXABLE_IND) TAXABLE_IND,
                 TRIM(XTERN_RDWT.ENTRY_MODE) ENTRY_MODE,
                 TRIM(XTERN_RDWT.DEPARTMENT) DEPARTMENT,
                 TRIM(XTERN_RDWT.CLASS) CLASS,
                 TRIM(XTERN_RDWT.SUBCLASS) SUBCLASS,
                 TRIM(XTERN_RDWT.TOT_SALES_QUANTITY) TOT_SALES_QUANTITY,
                 TRIM(XTERN_RDWT.TOT_TRANSACTION_VAL) TOT_TRANSACTION_VAL,
                 TRIM(XTERN_RDWT.OVERRIDE_REASON) OVERRIDE_REASON,
                 TRIM(XTERN_RDWT.RETURN_REASON) RETURN_REASON,
                 TRIM(XTERN_RDWT.TOT_ORIG_SIGN) TOT_ORIG_SIGN,
                 TRIM(XTERN_RDWT.TOT_ORIG_SALES_VAL) TOT_ORIG_SALES_VAL,
                 TRIM(XTERN_RDWT.WEATHER) WEATHER,
                 TRIM(XTERN_RDWT.TEMPERATURE) TEMPERATURE,
                 TRIM(XTERN_RDWT.TRAFFIC) TRAFFIC,
                 TRIM(XTERN_RDWT.CONSTRUCTION) CONSTRUCTION,
                 TRIM(XTERN_RDWT.DROP_SHIPMENT_IND) DROP_SHIPMENT_IND,
                 TRIM(XTERN_RDWT.DISCOUNT_TYPE) DISCOUNT_TYPE,
                 TRIM(XTERN_RDWT.PROMO_TRANSACTION_TYPE) PROMO_TRANSACTION_TYPE,
                 TRIM(XTERN_RDWT.PROMO_NO) PROMO_NO,
                 TRIM(XTERN_RDWT.PROMO_COMPONENT_NO) PROMO_COMPONENT_NO,
                 TRIM(XTERN_RDWT.COUPON_NO) COUPON_NO,
                 TRIM(XTERN_RDWT.COUPON_REF_NO) COUPON_REF_NO,
                 TRIM(XTERN_RDWT.SALES_QUANTITY) SALES_QUANTITY,
                 TRIM(XTERN_RDWT.TRANSACTION_SIGN) TRANSACTION_SIGN,
                 TRIM(XTERN_RDWT.TRANSACTION_VAL) TRANSACTION_VAL,
                 TRIM(XTERN_RDWT.DISCOUNT_VAL) DISCOUNT_VAL,
                 TRIM((XTERN_RDWT.TOT_TRANSACTION_VAL +
                      nvl(XTERN_RDWT.DISCOUNT_VAL, 0)) /
                      XTERN_RDWT.TOT_SALES_QUANTITY) UNIT_RETAIL
            from RA_RMS.BBG_XTERN_RDWT_2015091516 XTERN_RDWT
           where XTERN_RDWT.BUSINESS_DT='20150916') S;

--4.修改数据源
--rms
RA_RMS.BBG_RA_ITEM_LOC_SOH_V;

--金力销售插入W_RTL_SLS_TRX_IT_LC_DY_FS
INSERT INTO RADM.W_RTL_SLS_TRX_IT_LC_DY_FS
  (SLS_TRX_ID,
   PROD_IT_NUM,
   ORG_NUM,
   DAY_DT,
   VOUCHER_ID,
   RTL_TYPE_CODE,
   MIN_NUM,
   EMPLOYEE_NUM,
   SLS_QTY,
   SLS_AMT_LCL,
   SLS_PROFIT_AMT_LCL,
   SLS_TAX_AMT_LCL,
   SLS_EMP_DISC_AMT_LCL,
   SLS_MANUAL_COUNT,
   SLS_SCAN_COUNT,
   RET_QTY,
   RET_AMT_LCL,
   RET_PROFIT_AMT_LCL,
   RET_TAX_AMT_LCL,
   RET_EMP_DISC_AMT_LCL,
   RET_MANUAL_COUNT,
   RET_SCAN_COUNT,
   REJECT_FLG,
   SLS_MANUAL_MKDN_AMT_LCL,
   SLS_MANUAL_MKUP_AMT_LCL,
   RET_MANUAL_MKDN_AMT_LCL,
   RET_MANUAL_MKUP_AMT_LCL,
   EXCHANGE_DT,
   AUX1_CHANGED_ON_DT,
   AUX2_CHANGED_ON_DT,
   AUX3_CHANGED_ON_DT,
   AUX4_CHANGED_ON_DT,
   CHANGED_BY_ID,
   CHANGED_ON_DT,
   CREATED_BY_ID,
   CREATED_ON_DT,
   DATASOURCE_NUM_ID,
   DELETE_FLG,
   DOC_CURR_CODE,
   ETL_THREAD_VAL,
   GLOBAL1_EXCHANGE_RATE,
   GLOBAL2_EXCHANGE_RATE,
   GLOBAL3_EXCHANGE_RATE,
   INTEGRATION_ID,
   LOC_CURR_CODE,
   LOC_EXCHANGE_RATE,
   TENANT_ID,
   X_CUSTOM,
   BBG_RETAIL_TYPE_ID,
   BBG_SERVICE_SATISFACTION,
   SRC_REF_NO1,
   SRC_REF_NO2,
   SRC_REF_NO3,
   SRC_REF_NO6,
   SRC_REF_NO7,
   SRC_REF_NO8,
   BBG_REFERENCE_DO1,
   BBG_REFERENCE_DO2,
   BBG_REFERENCE_DO3,
   BBG_REFERENCE_DO4,
   BBG_REFERENCE_DO5,
   BBG_REFERENCE_FO1,
   BBG_REFERENCE_FO2,
   BBG_REFERENCE_FO3,
   BBG_REFERENCE_FO4,
   BBG_REFERENCE_FO5,
   BBG_REFERENCE_FO6,
   BBG_REFERENCE_FO7,
   BBG_REFERENCE_FO8,
   BBG_REFERENCE_FO9,
   BBG_REFERENCE_FO10,
   HYK_NO)
  SELECT T.SLS_TRX_ID,
         T.PROD_IT_NUM,
         T.ORG_NUM,
         T.DAY_DT,
         -1 VOUCHER_ID,
         T.RTL_TYPE_CODE,
         T.MIN_NUM,
         -1 EMPLOYEE_NUM,
         T.SLS_QTY,
         T.SLS_AMT_LCL,
         T.SLS_PROFIT_AMT_LCL,
         T.SLS_TAX_AMT_LCL,
         T.SLS_EMP_DISC_AMT_LCL,
         T.SLS_MANUAL_COUNT,
         T.SLS_SCAN_COUNT,
         ABS(T.RET_QTY) RET_QTY,
         ABS(T.RET_AMT_LCL) RET_AMT_LCL,
         T.RET_PROFIT_AMT_LCL,
         ABS(T.RET_TAX_AMT_LCL) RET_TAX_AMT_LCL,
         T.RET_EMP_DISC_AMT_LCL,
         T.RET_MANUAL_COUNT,
         T.RET_SCAN_COUNT,
         NULL REJECT_FLG,
         T.SLS_MANUAL_MKDN_AMT_LCL,
         T.SLS_MANUAL_MKUP_AMT_LCL,
         T.RET_MANUAL_MKDN_AMT_LCL,
         T.RET_MANUAL_MKUP_AMT_LCL,
         T.DAY_DT EXCHANGE_DT,
         NULL AUX1_CHANGED_ON_DT,
         NULL AUX2_CHANGED_ON_DT,
         NULL AUX3_CHANGED_ON_DT,
         NULL AUX4_CHANGED_ON_DT,
         -1 CHANGED_BY_ID,
         SYSDATE CHANGED_ON_DT,
         -1 CREATED_BY_ID,
         SYSDATE CREATED_ON_DT,
         1 DATASOURCE_NUM_ID,
         NULL DELETE_FLG,
         'CNY' DOC_CURR_CODE,
         (SELECT L.THREAD_VAL
            FROM RA_RMS.RA_RESTART_LOC@RA_RMS_DBLINK L
           WHERE T.ORG_NUM = L.DRIVER_VALUE
             AND L.SCENARIO_NAME = 'SDE_BBG_RETAIL_SALESTRANSACTIONFACT') ETL_THREAD_VAL,
         NULL GLOBAL1_EXCHANGE_RATE,
         NULL GLOBAL2_EXCHANGE_RATE,
         NULL GLOBAL3_EXCHANGE_RATE,
         T.SLS_TRX_ID || '~' || T.PROD_IT_NUM || '~-1~' ||
         TO_CHAR(T.DAY_DT, 'DD-MON-YY', 'NLS_DATE_LANGUAGE = American') INTEGRATION_ID,
         'CNY' LOC_CURR_CODE,
         NULL LOC_EXCHANGE_RATE,
         NULL TENANT_ID,
         NULL X_CUSTOM,
         T.BBG_RETAIL_TYPE_ID,
         3.5 BBG_SERVICE_SATISFACTION,
         NULL SRC_REF_NO1,
         NULL SRC_REF_NO2,
         NULL SRC_REF_NO3,
         T.PROD_IT_NUM SRC_REF_NO6,
         NULL SRC_REF_NO7,
         NULL SRC_REF_NO8,
         NULL BBG_REFERENCE_DO1,
         NULL BBG_REFERENCE_DO2,
         NULL BBG_REFERENCE_DO3,
         NULL BBG_REFERENCE_DO4,
         NULL BBG_REFERENCE_DO5,
         NULL BBG_REFERENCE_FO1,
         NULL BBG_REFERENCE_FO2,
         NULL BBG_REFERENCE_FO3,
         NULL BBG_REFERENCE_FO4,
         NULL BBG_REFERENCE_FO5,
         NULL BBG_REFERENCE_FO6,
         NULL BBG_REFERENCE_FO7,
         NULL BBG_REFERENCE_FO8,
         NULL BBG_REFERENCE_FO9,
         NULL BBG_REFERENCE_FO10,
         T.HYK_NO HYK_NO
    FROM (SELECT SLS_TRX_ID,
                 PROD_IT_NUM,
                 ORG_NUM,
                 DAY_DT,
                 VOUCHER_ID,
                 RTL_TYPE_CODE,
                 MIN_NUM,
                 SLS_QTY,
                 SLS_AMT_LCL,
                 SLS_PROFIT_AMT_LCL,
                 SLS_TAX_AMT_LCL,
                 SLS_EMP_DISC_AMT_LCL,
                 SLS_MANUAL_COUNT,
                 SLS_SCAN_COUNT,
                 -RET_QTY                 RET_QTY,
                 -RET_AMT_LCL             RET_AMT_LCL,
                 -RET_PROFIT_AMT_LCL      RET_PROFIT_AMT_LCL,
                 -RET_TAX_AMT_LCL         RET_TAX_AMT_LCL,
                 -RET_EMP_DISC_AMT_LCL    RET_EMP_DISC_AMT_LCL,
                 -RET_MANUAL_COUNT        RET_MANUAL_COUNT,
                 -RET_SCAN_COUNT          RET_SCAN_COUNT,
                 SLS_MANUAL_MKDN_AMT_LCL,
                 SLS_MANUAL_MKUP_AMT_LCL,
                 -RET_MANUAL_MKDN_AMT_LCL RET_MANUAL_MKDN_AMT_LCL,
                 -RET_MANUAL_MKUP_AMT_LCL RET_MANUAL_MKUP_AMT_LCL,
                 BBG_RETAIL_TYPE_ID,
                 HYK_NO
            FROM BBG_RA_SLS_TRX_JL_V@RA_JL
           WHERE --DAY_DT = TRUNC(SYSDATE - 1)
           DAY_DT = DATE '2015-09-16') T;


--5.备份RADM.W_RTL_SLS_TRX_IT_LC_DY_FS表
CREATE TABLE RADM.W_RTL_SLS_TRX_IT_LC_DY_FS_15 AS
SELECT * FROM W_RTL_SLS_TRX_IT_LC_DY_FS;

TRUNCATE TABLE RA_RMS.C_LOAD_DATES;
TRUNCATE TABLE RADM.C_LOAD_DATES;
--6.

--7.

TRIM((XTERN_RDWT.TOT_TRANSACTION_VAL+nvl(XTERN_RDWT.DISCOUNT_VAL,0))/XTERN_RDWT.TOT_SALES_QUANTITY)

SELECT * FROM RADM.BBG_RA_RETAIL_TYPE_D;

SELECT * FROM RADM.W_RTL_SLS_IT_LC_DY_A T WHERE T.BBG_RETAIL_TYPE_WID=17 AND T.DT_WID=120150916000;


SELECT DISTINCT T.BUSINESS_DT FROM RA_RMS.BBG_XTERN_RDWT_2015091516 T;

SELECT COUNT(*) FROM RA_RMS.BBG_XTERN_RDWT_HIST T WHERE T.BUSINESS_DT IN (20150915,20150916);
SELECT COUNT(*) FROM RA_RMS.BBG_XTERN_RDWT_2015091516 T;
