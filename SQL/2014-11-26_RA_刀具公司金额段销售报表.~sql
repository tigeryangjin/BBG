--A.全司销售创建视图封装金额段
-- VIEW NAME:   RADM.BBG_RA_SLS_SEQ_DY_LC_FV 
SELECT /*+PARALLEL(T,20)*/
 *
  FROM RADM.BBG_RA_SLS_SEQ_DY_LC_FV T
 WHERE T.DT_WID = 120141111000;

--B.全司-hyper-mart 12-超市
SELECT /*+PARALLEL(S,20) PARALLEL(O,20)*/
 SUBSTR(S.DT_WID, 2, 6) MONTH,
 S.SEQ,
 COUNT(S.SLS_TRX_ID) CNT,
 SUM(S.SLS_AMT) SLS_AMT
  FROM RADM.BBG_RA_SLS_SEQ_DY_LC_FV S, RADM.W_INT_ORG_DH O
 WHERE S.ORG_SCD1_WID = O.SCD1_WID
   AND O.ORG_HIER13_NUM = 12
   AND S.DT_WID BETWEEN 120140101000 AND 120141130000
 GROUP BY SUBSTR(S.DT_WID, 2, 6), S.SEQ
 ORDER BY SUBSTR(S.DT_WID, 2, 6), S.SEQ;

--C.全司-super-mart 11-大卖场
SELECT /*+PARALLEL(S,20) PARALLEL(O,20)*/
 SUBSTR(S.DT_WID, 2, 6) MONTH,
 S.SEQ,
 COUNT(S.SLS_TRX_ID) CNT,
 SUM(S.SLS_AMT) SLS_AMT
  FROM RADM.BBG_RA_SLS_SEQ_DY_LC_FV S, RADM.W_INT_ORG_DH O
 WHERE S.ORG_SCD1_WID = O.SCD1_WID
   AND O.ORG_HIER13_NUM = 11
   AND S.DT_WID BETWEEN 120140101000 AND 120141130000
 GROUP BY SUBSTR(S.DT_WID, 2, 6), S.SEQ
 ORDER BY SUBSTR(S.DT_WID, 2, 6), S.SEQ;

--D.会员销售金额段视图
-- VIEW NAME:   RADM.BBG_RA_SLS_VIP_SEQ_DY_LC_FV
SELECT *
  FROM RADM.BBG_RA_SLS_VIP_SEQ_DY_LC_FV T
 WHERE T.JZRQ = DATE '2014-11-11';

--E.会员-hyper-mart 12-超市 
SELECT /*+PARALLEL(S,20) PARALLEL(O,20)*/
 SUBSTR(TO_CHAR(S.JZRQ, 'YYYYMMDD'), 1, 6) MONTH,
 S.SEQ,
 COUNT(S.SLS_TRX_ID) CNT,
 SUM(S.VIP_SLS_AMT) VIP_SLS_AMT
  FROM RADM.BBG_RA_SLS_VIP_SEQ_DY_LC_FV S,
       (select DISTINCT T.ORG_HIER13_NUM, T.ORG_HIER9_NUM
          from W_INT_ORG_DH t) O
 WHERE S.LOC = O.ORG_HIER9_NUM
   AND O.ORG_HIER13_NUM = 12
   AND S.JZRQ BETWEEN DATE '2014-01-01' AND DATE '2014-11-30'
 GROUP BY SUBSTR(TO_CHAR(S.JZRQ, 'YYYYMMDD'), 1, 6), S.SEQ
 ORDER BY SUBSTR(TO_CHAR(S.JZRQ, 'YYYYMMDD'), 1, 6), S.SEQ;
--F.会员-super-mart 11-大卖场
SELECT /*+PARALLEL(S,20) PARALLEL(O,20)*/
 SUBSTR(TO_CHAR(S.JZRQ, 'YYYYMMDD'), 1, 6) MONTH,
 S.SEQ,
 COUNT(S.SLS_TRX_ID) CNT,
 SUM(S.VIP_SLS_AMT) VIP_SLS_AMT
  FROM RADM.BBG_RA_SLS_VIP_SEQ_DY_LC_FV S,
       (select DISTINCT T.ORG_HIER13_NUM, T.ORG_HIER9_NUM
          from W_INT_ORG_DH t) O
 WHERE S.LOC = O.ORG_HIER9_NUM
   AND O.ORG_HIER13_NUM = 11
   AND S.JZRQ BETWEEN DATE '2014-01-01' AND DATE '2014-11-30'
 GROUP BY SUBSTR(TO_CHAR(S.JZRQ, 'YYYYMMDD'), 1, 6), S.SEQ
 ORDER BY SUBSTR(TO_CHAR(S.JZRQ, 'YYYYMMDD'), 1, 6), S.SEQ;
------------------------------------------------------------------------------
SELECT TRX.ORG_NUM,
       COUNT(TRX.SLS_TRX_ID) TRX_CNT,
       SUM(TRX.AMT) AMT,
       SUM(TRX.OVER100CNT) OVER100CNT,
       SUM(TRX.OVER100AMT) OVER100AMT
  FROM (SELECT /*+PARALLEL(ST,20) (SH,20) (SD,20) (STD,20)*/
         ST.STORE ORG_NUM,
         ST.TRAN_SEQ_NO SLS_TRX_ID,
         SUM(ST.QTY * (ST.UNIT_RETAIL - NVL(STD.UNIT_DISCOUNT_AMT, 0))) AMT,
         CASE
           WHEN SUM(ST.QTY * (ST.UNIT_RETAIL - NVL(STD.UNIT_DISCOUNT_AMT, 0))) >= 38 THEN --客单价
            1
           ELSE
            0
         END OVER100CNT,
         CASE
           WHEN SUM(ST.QTY * (ST.UNIT_RETAIL - NVL(STD.UNIT_DISCOUNT_AMT, 0))) >= 38 THEN --客单价
            SUM(ST.QTY * (ST.UNIT_RETAIL - NVL(STD.UNIT_DISCOUNT_AMT, 0)))
           ELSE
            0
         END OVER100AMT
          FROM SA_TRAN_ITEM ST,
               SA_TRAN_HEAD SH,
               SA_STORE_DAY SD,
               SA_TRAN_DISC STD
         WHERE ST.STORE = SH.STORE
           AND ST.DAY = SH.DAY
           AND ST.TRAN_SEQ_NO = SH.TRAN_SEQ_NO
           AND SH.STORE_DAY_SEQ_NO = SD.STORE_DAY_SEQ_NO
           AND SH.STORE = SD.STORE
           AND SH.DAY = SD.DAY
           AND ST.STORE = STD.STORE(+)
           AND ST.DAY = STD.DAY(+)
           AND ST.TRAN_SEQ_NO = STD.TRAN_SEQ_NO(+)
           AND ST.ITEM_SEQ_NO = STD.ITEM_SEQ_NO(+)
           AND SD.BUSINESS_DATE BETWEEN DATE '2014-02-10' AND DATE
         '2014-02-22' --销售日期
           AND SUBSTR(ST.DEPT, 1, 2) IN (27) --大类
           AND EXISTS (SELECT /*+PARALLEL(H,20) (M,20)*/
                 'X'
                  FROM RADM.HYXFJL@RMS_RA H, RADM.MDDY@RMS_RA M
                 WHERE H.MDID = M.MDID
                   AND SUBSTR(M.MDDM, 3, 6) = TO_CHAR(ST.STORE)
                   AND H.JLBH = SH.TRAN_NO
                   AND H.SKTNO = SH.REGISTER
                   AND H.JZRQ = SD.BUSINESS_DATE)
         GROUP BY ST.STORE, ST.TRAN_SEQ_NO) TRX
 GROUP BY TRX.ORG_NUM
 ORDER BY TRX.ORG_NUM;
