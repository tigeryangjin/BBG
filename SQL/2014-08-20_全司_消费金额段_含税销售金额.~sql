--全司_历史_消费段_含税销售金额
SELECT S1.MONTH, S1.PRICE_LEVEL, S1.DSC1, SUM(S1.AMT) AMT
  FROM (SELECT SLS.MONTH, SLS.LOC, SLS.TRX, SD.PRICE_LEVEL, SD.DSC1, SLS.AMT
          FROM (SELECT SUBSTR(S.SD0101, 1, 6) MONTH,
                       SUBSTR(S.SHOPID, 2, 2) || SUBSTR(S.SHOPID, 1, 1) ||
                       SUBSTR(S.SHOPID, 4, 3) LOC,
                       S.SD0101 || S.SHOPID || S.SD0106 || S.SD0109 TRX,
                       SUM(S.AMT) AMT
                  FROM RADM.SALEDETAIL S
                 WHERE S.SD0101 BETWEEN 20130101 AND 20130507
                 GROUP BY SUBSTR(S.SD0101, 1, 6),
                          SUBSTR(S.SHOPID, 2, 2) || SUBSTR(S.SHOPID, 1, 1) ||
                          SUBSTR(S.SHOPID, 4, 3),
                          S.SD0101 || S.SHOPID || S.SD0106 || S.SD0109) SLS,
               RADM.BBG_RA_SLS_SEGMENT_D SD
         WHERE SLS.AMT BETWEEN SD.LOW AND SD.HIGH) S1
 GROUP BY S1.MONTH, S1.PRICE_LEVEL, S1.DSC1
 ORDER BY S1.MONTH, S1.PRICE_LEVEL;

--全司_历史_门店_含税销售金额
SELECT S1.MONTH, S1.LOC, SUM(S1.AMT) AMT
  FROM (SELECT SLS.MONTH, SLS.LOC, SLS.TRX, SD.PRICE_LEVEL, SD.DSC1, SLS.AMT
          FROM (SELECT SUBSTR(S.SD0101, 1, 6) MONTH,
                       SUBSTR(S.SHOPID, 2, 2) || SUBSTR(S.SHOPID, 1, 1) ||
                       SUBSTR(S.SHOPID, 4, 3) LOC,
                       S.SD0101 || S.SHOPID || S.SD0106 || S.SD0109 TRX,
                       SUM(S.AMT) AMT
                  FROM RADM.SALEDETAIL S
                 WHERE S.SD0101 BETWEEN 20130101 AND 20130507
                 GROUP BY SUBSTR(S.SD0101, 1, 6),
                          SUBSTR(S.SHOPID, 2, 2) || SUBSTR(S.SHOPID, 1, 1) ||
                          SUBSTR(S.SHOPID, 4, 3),
                          S.SD0101 || S.SHOPID || S.SD0106 || S.SD0109) SLS,
               RADM.BBG_RA_SLS_SEGMENT_D SD
         WHERE SLS.AMT BETWEEN SD.LOW AND SD.HIGH) S1
 GROUP BY S1.MONTH, S1.LOC
 ORDER BY S1.MONTH, S1.LOC;

SELECT DISTINCT T.SD0101
  FROM RADM.SALEDETAIL T
 WHERE T.SD0101 BETWEEN 20130101 AND 20130507
 ORDER BY T.SD0101;

SELECT * FROM RADM.SALEDETAIL;

--全司_消费金额段_含税销售金额
SELECT SUBSTR(T.DT_WID, 2, 6) MONTH,
       T.PRICE_LEVEL,
       COUNT(T.SLS_TRX_ID) SLS_TRX_CNT,
       SUM(T.SLS_AMT_LCL) SLS_AMT_LCL
  FROM (SELECT FV.DT_WID,
               FV.SLS_TRX_ID,
               FV.SLS_AMT_LCL,
               LEV.Dsc1 PRICE_LEVEL
          FROM (SELECT T.SLS_TRX_ID,
                       T.DT_WID,
                       SUM(T.SLS_AMT_LCL - T.RET_AMT_LCL) SLS_AMT_LCL
                  FROM RADM.W_RTL_SLS_TRX_IT_LC_DY_F T
                 GROUP BY T.SLS_TRX_ID, T.DT_WID) FV,
               RADM.BBG_RA_SLS_SEGMENT_D LEV
         WHERE FV.SLS_AMT_LCL BETWEEN LEV.LOW AND LEV.HIGH
           AND LEV.SEGMENT_NAME = '宝莱消费金额段'
           AND FV.DT_WID BETWEEN 120130101000 AND 120140731000) T
 GROUP BY SUBSTR(T.DT_WID, 2, 6), T.PRICE_LEVEL;

--全司分段销售来客数
SELECT SUBSTR(T.DT_WID, 2, 6) MONTH,
       S.PRICE_LEVEL,
       S.DSC1,
       SUM(T.SLS_TRX_CNT) SLS_TRX_CNT
  FROM RADM.BBG_RA_SLSTOT_LC_DY_A T, RADM.BBG_RA_SLS_SEGMENT_D S
 WHERE T.PRICE_LEVEL = S.PRICE_LEVEL
   AND T.DT_WID BETWEEN 120130101000 AND 120140731000
 GROUP BY SUBSTR(T.DT_WID, 2, 6), S.PRICE_LEVEL, S.DSC1
 ORDER BY SUBSTR(T.DT_WID, 2, 6), S.PRICE_LEVEL;

--全司门店销售来客数
SELECT SUBSTR(T.DT_WID, 2, 6) MONTH,
       O.ORG_NUM,
       SUM(T.BBG_CUSTOMER_COUNT) SLS_TRX_CNT
  FROM RADM.BBG_RA_CUST_LC_DY_A T, RABATCHER.W_INT_ORG_D_RTL_TMP O
 WHERE T.ORG_WID = O.ORG_WID
   AND T.DT_WID BETWEEN 120130101000 AND 120140731000
 GROUP BY SUBSTR(T.DT_WID, 2, 6), O.ORG_NUM
 ORDER BY SUBSTR(T.DT_WID, 2, 6), O.ORG_NUM;

--会员门店销售来客数
SELECT SUBSTR(T.DT_WID, 2, 6) MONTH,
       O.ORG_NUM,
       SUM(T.VIP_CUSTOMER_COUNT) SLS_TRX_CNT
  FROM RADM.bbg_ra_VIPSLS_LC_DY_A T, RABATCHER.W_INT_ORG_D_RTL_TMP O
 WHERE T.ORG_WID = O.ORG_WID
   AND T.DT_WID BETWEEN 120130101000 AND 120140731000
 GROUP BY SUBSTR(T.DT_WID, 2, 6), O.ORG_NUM
 ORDER BY SUBSTR(T.DT_WID, 2, 6), O.ORG_NUM;

--REPORT 2 --会员门店销售来客数
DROP MATERIALIZED VIEW RADM.YJ_VIP_SLS_CNT;
CREATE MATERIALIZED VIEW RADM.YJ_VIP_SLS_CNT AS
  SELECT D.MONTH 月份, SUBSTR(M.MDDM, 3, 6) 门店编码, D.HYCNT 消费来客数
    FROM (SELECT A.MONTH, A.MDID, SUM(A.HYCNT) HYCNT
            FROM (SELECT DISTINCT T.XFJLID,
                                  T.MDID,
                                  SUBSTR(TO_CHAR(T.JZRQ, 'YYYYMMDD'), 1, 6) MONTH,
                                  1 HYCNT
                    FROM RADM.HYXFJL T
                   WHERE T.SHDM = 'CS'
                     AND T.JZRQ BETWEEN DATE '2013-01-01' AND DATE
                   '2014-07-31'
                   GROUP BY T.XFJLID,
                            T.MDID,
                            SUBSTR(TO_CHAR(T.JZRQ, 'YYYYMMDD'), 1, 6)) A
           GROUP BY A.MONTH, A.MDID) D,
         RADM.MDDY M
   WHERE D.MDID = M.MDID;

--会员来客数核对
SELECT * FROM RADM.YJ_VIP_SLS_CNT T WHERE T.月份 = 201301;
SELECT * FROM RADM.YJ_VIP_SLS_CNT_1 T WHERE T.月份 = 201301;

SELECT A.月份,
       A.门店会员来客,
       B.月份,
       B.分段会员来客,
       A.门店会员来客 - B.分段会员来客
  FROM (SELECT T1.月份, SUM(T1.消费来客数) 门店会员来客
          FROM RADM.YJ_VIP_SLS_CNT T1
         GROUP BY T1.月份) A,
       (SELECT T2.月份, SUM(T2.消费来客数) 分段会员来客
          FROM RADM.YJ_VIP_SLS_CNT_1 T2
         GROUP BY T2.月份) B
 WHERE A.月份 = B.月份;

SELECT * FROM RADM.HYXFJL T WHERE T.JE = 0;
