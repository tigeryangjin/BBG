--按月每日求和INV_SOH_QTY，INV_SOH_COST_AMT_LCL
CREATE MATERIALIZED VIEW W_RTL_INV_IT_LC_MN_AVG_FV
AS
SELECT T964463.ORG_NUM,
       T14449.PROD_NUM,
       SUBSTR(T963640.DT_WID,2,6) MONTH,
       sum(NVL(T963640.INV_SOH_QTY,0)) as INV_SOH_QTY_MN,
       sum(NVL(T963640.INV_SOH_COST_AMT_LCL,0)) as INV_SOH_COST_AMT_LCL_MN,
       sum(NVL(T963640.INV_SOH_QTY,0))/TO_NUMBER(LAST_DAY(TO_DATE(SUBSTR(DT_WID,2,8),'YYYYMMDD'))-TRUNC( TO_DATE(SUBSTR(DT_WID,2,8),'YYYYMMDD'),'MONTH')+1) AS INV_SOH_QTY_MN_AVG,
       sum(NVL(T963640.INV_SOH_COST_AMT_LCL,0))/TO_NUMBER(LAST_DAY(TO_DATE(SUBSTR(DT_WID,2,8),'YYYYMMDD'))-TRUNC( TO_DATE(SUBSTR(DT_WID,2,8),'YYYYMMDD'),'MONTH')+1) AS INV_SOH_COST_AMT_LCL_MN_AVG
FROM W_RTL_INV_IT_LC_DY_FV T963640,
     W_INT_ORG_D T964463,
     W_PRODUCT_D T14449
WHERE T963640.ORG_WID = T964463.ROW_WID 
   and T14449.ROW_WID = T963640.PROD_WID
GROUP BY T964463.ORG_NUM,T14449.PROD_NUM,SUBSTR(T963640.DT_WID,2,6),
         TRUNC( TO_DATE(SUBSTR(DT_WID,2,8),'YYYYMMDD'),'MONTH'),
         LAST_DAY(TO_DATE(SUBSTR(DT_WID,2,8),'YYYYMMDD'));
         
--按月，（上月末+本月末）/2 例如：（5月31+6月30）/2
CREATE MATERIALIZED VIEW W_RTL_INV_IT_LC_MN_AVG2_FV
AS
SELECT T964463.ORG_NUM,
       T14449.PROD_NUM,
       SUBSTR(T963640.DT_WID,2,6) MONTH,
       sum(NVL(T963640.INV_SOH_QTY,0)+NVL(T963640.INV_IN_TRAN_QTY,0)) as INV_SOH_QTY_MN,--加入从配送到门店的在途
       sum(NVL(T963640.INV_SOH_COST_AMT_LCL,0)+NVL(T963640.INV_ON_ORD_COST_AMT_LCL,0)) as INV_SOH_COST_AMT_LCL_MN,--加入从配送到门店的在途
       sum(NVL(T963640.INV_SOH_QTY,0)+NVL(T963640.INV_IN_TRAN_QTY,0))/2 AS INV_SOH_QTY_MN_AVG,--加入从配送到门店的在途
       sum(NVL(T963640.INV_SOH_COST_AMT_LCL,0)+NVL(T963640.INV_ON_ORD_COST_AMT_LCL,0))/2 AS INV_SOH_COST_AMT_LCL_MN_AVG --加入从配送到门店的在途
FROM W_RTL_INV_IT_LC_DY_FV T963640,
     W_INT_ORG_D T964463,
     W_PRODUCT_D T14449
WHERE T963640.ORG_WID = T964463.ROW_WID 
   and T14449.ROW_WID = T963640.PROD_WID
   and (
       --上月最后一天
       TO_DATE(SUBSTR(DT_WID,2,8),'YYYYMMDD') = TRUNC( TO_DATE(SUBSTR(DT_WID,2,8),'YYYYMMDD'),'MONTH')-1
       --本月最后一天
       OR 
       TO_DATE(SUBSTR(DT_WID,2,8),'YYYYMMDD') = LAST_DAY(TO_DATE(SUBSTR(DT_WID,2,8),'YYYYMMDD'))
       )
GROUP BY T964463.ORG_NUM,T14449.PROD_NUM,SUBSTR(T963640.DT_WID,2,6);


SELECT LAST_DAY(TO_DATE(SUBSTR('120130715000',2,8),'YYYYMMDD')) FROM DUAL

SELECT * FROM W_RTL_INV_IT_LC_DY_FV T
WHERE T.ORG_WID=94 AND PROD_WID=308060;

select distinct 0 as c1,
     D1.c3 as c2,
     D1.c4 as c3,
     D1.c5 as c4,
     D1.c2 as c5,
     D1.c1 as c6,
     D1.c6 as c7,
     D1.c7 as c8,
     D1.c8 as c9
from 
     (select sum(T963640.INV_SOH_QTY) as c1,
               sum(T963640.INV_SOH_COST_AMT_LCL) as c2,
                TRUNC(T960506.MCAL_DAY_DT) as c3,
               T14449.PROD_NUM as c4,
               cast(T964463.ORG_NUM as  INTEGER  ) as c5,
               T964463.ROW_WID as c6,
               T14449.ROW_WID as c7,
               T960506.ROW_WID as c8
          from 
               W_INT_ORG_DH T964333 /* Dim_W_INT_ORG_DH_Retail_As_Was */ ,
               W_INT_ORG_D T964463 /* Dim_W_INT_ORG_D_Retail_As_Was */ ,
               W_MCAL_DAY_DV T960506 /* Dim_W_MCAL_DAY_D_Retail_Gregorian_Calendar */ ,
               (SELECT T.*
  FROM W_PRODUCT_D T, W_PRODUCT_ATTR_D A
 WHERE T.SCD1_WID = A.SCD1_WID
   AND A.PRODUCT_ATTR12_NAME = A.PRODUCT_ATTR11_NAME) T14449,
               W_RTL_INV_IT_LC_DY_FV T963640 /* Fact_W_RTL_INV_IT_LC_DY_F */ 
          where  ( T963640.ORG_DH_WID = T964333.ROW_WID and T963640.ORG_WID = T964463.ROW_WID 
          and T960506.ROW_WID = T963640.DT_WID and T14449.ROW_WID = T963640.PROD_WID 
          and T960506.MCAL_CAL_WID = 1.0 and T964333.SCD1_WID = T964463.SCD1_WID 
          and  TRUNC(T960506.MCAL_DAY_DT) = TO_DATE('2013-07-14' , 'YYYY-MM-DD') and '2010' < T960506.CAL_YEAR ) 
          group by T14449.ROW_WID, T14449.PROD_NUM, T960506.ROW_WID, T964463.ROW_WID, cast(T964463.ORG_NUM as  INTEGER  ),  TRUNC(T960506.MCAL_DAY_DT)
     ) D1
order by c3, c4, c2
