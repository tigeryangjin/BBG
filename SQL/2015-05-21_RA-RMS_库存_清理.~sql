--RMS
SELECT *
  FROM CMX_SUPP_INV T
 WHERE T.ITEM = '800044955'
   AND T.LOC = '118010';

SELECT *
  FROM CMX_SUPP_INV_HIST T
 WHERE T.ITEM = '800044955'
   AND T.LOC = '118010';

SELECT *
  FROM ITEM_LOC_SOH T
 WHERE T.ITEM = '800044955'
   AND T.LOC = '118010';

--RA
SELECT *
  FROM RADM.BBG_RA_SUPP_INV_IT_LC_G T
 WHERE T.PROD_IT_NUM = '101440187'
   AND T.ORG_NUM = '120145';

SELECT *
  FROM RADM.BBG_RA_SUPP_INV_IT_LC_DY_F T
 WHERE T.PROD_WID = 1600200
   AND T.ORG_WID = 129;

SELECT *
  FROM RADM.W_RTL_INV_IT_LC_G T
 WHERE T.PROD_DP_NUM IN (35, 36)
 ORDER BY T.INV_SOH_QTY DESC;

--清理库存注意点:BBG_RA_SUPP_INV_IT_LC_DY_F和BBG_RA_SUPP_INV_IT_LC_G要保持一致!!!!!

--1.剔出不为0的数据,并且rms和ra一致的数据
DROP TABLE RADM.BBG_RA_SUP_INV_IT_LC_DY_FS_BAK;

CREATE TABLE RADM.BBG_RA_SUP_INV_IT_LC_DY_FS_BAK AS
  SELECT *
    FROM RADM.BBG_RA_SUP_INV_IT_LC_DY_FS T
   WHERE T.SUPP_INV_QTY = 0
     AND EXISTS (SELECT 1
            FROM RADM.BBG_RA_SUPP_INV_IT_LC_G E
           WHERE T.PROD_IT_NUM = E.PROD_IT_NUM
             AND T.ORG_NUM = E.ORG_NUM
             AND T.SUPPLIER_NUM = E.SUPPLIER_NUM
             AND E.SUPP_INV_QTY <> T.SUPP_INV_QTY)
     AND EXISTS
   (SELECT 1
            FROM (SELECT DISTINCT C.ITEM, C.LOC, C.SUPPLIER
                    FROM RMS.CMX_SUPP_INV_HIST@RA_RMS_DBLINK C
                   WHERE C.V_DATE = DATE '2015-05-20'
                     AND C.REFERENCE_NO1 = '20150521FIX'
                     AND NOT EXISTS (SELECT 1
                            FROM RMS.CMX_SUPP_INV@RA_RMS_DBLINK A
                           WHERE A.ITEM = C.ITEM
                             AND A.LOC = C.LOC
                             AND A.SUPPLIER = C.SUPPLIER)
                     AND NOT EXISTS
                   (SELECT 1
                            FROM RMS.CMX_SUPP_INV_HIST@RA_RMS_DBLINK B
                           WHERE B.REFERENCE_NO1 <> '20150521FIX'
                             AND B.ITEM = C.ITEM
                             AND B.LOC = C.LOC
                             AND B.SUPPLIER = C.SUPPLIER)) D
           WHERE T.PROD_IT_NUM = D.ITEM
             AND T.ORG_NUM = D.LOC
             AND T.SUPPLIER_NUM = D.SUPPLIER);

TRUNCATE TABLE RADM.BBG_RA_SUP_INV_IT_LC_DY_FS;

INSERT INTO RADM.BBG_RA_SUP_INV_IT_LC_DY_FS
  SELECT * FROM BBG_RA_SUP_INV_IT_LC_DY_FS_BAK;

--2.核对rms-ra的供应商库存,cmx_supp_inv没有的商品-地点-供应商记录,则RA库存=0.

SELECT *
  FROM RADM.BBG_RA_SUPP_INV_IT_LC_G A
 WHERE EXISTS
 (SELECT 1
          FROM (SELECT B.ITEM,
                       B.LOC,
                       B.SUPPLIER,
                       SUM(B.SOH) SOH,
                       SUM(B.WAC * B.SOH) TOTAL_COST
                  FROM CMX_SUPP_INV@RA_RMS_DBLINK B
                 GROUP BY B.ITEM, B.LOC, B.SUPPLIER) C
         WHERE A.ORG_NUM = C.LOC
           AND A.PROD_IT_NUM = C.ITEM
           AND A.SUPPLIER_NUM = C.SUPPLIER
           AND ROUND(A.SUPP_INV_COST, 3) <> ROUND(C.TOTAL_COST, 3));

SELECT *
  FROM CMX_SUPP_INV@RA_RMS_DBLINK T
 WHERE T.LOC = '120035'
   AND T.ITEM = '800037216'
   AND T.SUPPLIER = '29003202';

SELECT *
  FROM RADM.BBG_RA_SUPP_INV_IT_LC_G T
 WHERE T.ORG_NUM = '120035'
   AND T.PROD_IT_NUM = '800037216'
   AND T.SUPPLIER_NUM = '29003202';

SELECT T.W_UPDATE_DT, COUNT(*)
  FROM RADM.BBG_RA_SUPP_INV_IT_LC_G T
 WHERE TRUNC(T.W_UPDATE_DT) = DATE '2015-05-22'
 GROUP BY T.W_UPDATE_DT
 ORDER BY T.W_UPDATE_DT;
