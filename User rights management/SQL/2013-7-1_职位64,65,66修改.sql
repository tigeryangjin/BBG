--
SELECT * FROM RAINY_POSITION_ROLE WHERE POSITION_ID IN (64,65,66) AND ROLE_ID BETWEEN 170 AND 206;
DELETE RAINY_POSITION_ROLE WHERE POSITION_ID IN (64,65,66) AND ROLE_ID BETWEEN 170 AND 206;
--
insert into RAINY_POSITION_ROLE(role_id,position_id) values(170,64);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(170,65);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(170,66);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(171,64);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(171,65);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(171,66);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(172,64);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(172,65);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(172,66);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(174,64);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(174,65);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(174,66);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(176,64);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(176,65);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(176,66);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(180,64);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(180,65);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(180,66);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(182,64);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(182,65);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(182,66);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(185,64);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(185,65);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(185,66);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(186,64);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(186,65);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(186,66);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(187,64);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(187,65);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(187,66);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(188,64);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(188,65);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(188,66);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(189,64);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(189,65);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(189,66);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(190,64);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(190,65);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(190,66);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(191,64);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(191,65);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(191,66);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(192,64);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(192,65);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(192,66);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(193,64);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(193,65);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(193,66);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(194,64);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(194,65);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(194,66);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(195,64);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(195,65);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(195,66);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(196,64);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(196,65);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(196,66);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(197,64);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(197,65);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(197,66);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(198,64);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(198,65);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(198,66);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(199,64);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(199,65);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(199,66);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(200,64);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(200,65);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(200,66);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(201,64);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(201,65);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(201,66);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(202,64);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(202,65);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(202,66);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(203,64);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(203,65);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(203,66);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(204,64);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(204,65);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(204,66);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(205,64);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(205,65);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(205,66);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(206,64);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(206,65);
insert into RAINY_POSITION_ROLE(role_id,position_id) values(206,66);

----LDAP建用户
--SIM系统,RA/BIP系统共用一个用户，建立一个就OK了。
--SIM系统中LOC为ALL的，在建用户和权限导入时要分店别或类别进行
--注意：userstores: storeId=ALL 时要替换。。。替换整行。。。
SELECT 'dn: cn=' || ru.user_id || ',cn=Users,dc=bbg
changetype: add
#RPM
objectclass: retailUser
#SIM
objectclass: simUser
#General
objectclass: inetOrgPerson
objectclass: orclUser
objectclass: orclUserV2
objectclass: organizationalPerson
objectclass: person
objectclass: top
uid: ' || ru.user_id || chr (13 ) || 'cn:' || ru.user_id || chr(13 ) ||
        'sn: ' || ru.user_id || chr( 13) || 'description:' || rp.position ||
        chr( 13) || 'givenname: ' || ru.user_id || chr (13 ) || 'superUser: FALSE
empStatus: 0
preferredCountry: CN
preferredLanguage: zh
middleName: M1
mail: user0010@bbg.com
telephoneNumber: 800-111-2222
externalId: ' || ru.user_id || chr (13 ) || 'supervisor: X
startTimestamp: 20071026000000Z
#endTimestamp:
#defaultStore: storeId=' ||
        (SELECT rul.loc
           FROM rainy_user_loc rul
          WHERE rul.user_id = ru.user_id
            AND rownum = 1) || ',cn=SIMStores,cn=SIM,dc=bbg,dc=com
userpassword: ' || ru.password || chr (13 ) ||
       to_char ( (SELECT   wm_concat( 'userstores: storeId=' || rull.loc ||',cn=SIMStores,cn=SIM,dc=bbg' ||chr (13 ))
      
           FROM rainy_user_loc rull
          WHERE rull.user_id = ru.user_id
          GROUP BY rull.user_id ))
  FROM rainy_user ru , rainy_user_position rup , rainy_position rp
-- rainy_user_loc      rull
-- RAINY_LOC           rl
WHERE ru.user_id = rup.user_id
   AND rup.position_id = rp.position_id
--注意下面条件，当用户地点权限为ALL时才是=，不是ALL就是<>
   AND EXISTS( SELECT 1 FROM RAINY_USER_LOC RULL WHERE RULL.USER_ID=RU.USER_ID AND RULL.LOC<> 'ALL')
   --AND ru.user_id NOT IN (SELECT rull.user_id FROM rainy_user_loc rull WHERE rull.loc <> 'ALL')
   --AND RU.ID in (901,902)
   AND RUP.position_id in (64,65,66);
   
--RA/BIP权限导入
--查询出来的结果保存成txt文本文件，并且要把【”】去掉，然后用LDAP导入，file-->import 
--SIM,RA/BIP系统的用户的创建、权限的修改，都是通过LDAP导入。
SELECT 'dn: cn=' ||ra.role_name ||',cn=Groups,dc=bbg
changetype: modify
add: uniquemember
uniquemember: cn='||ru.user_id||',cn=users,dc=bbg
'
FROM RAINY_USER ru, RAINY_USER_POSITION rup,RAINY_POSITION_ROLE rpr,rainy_role ra
WHERE ru.user_id= rup.user_id
and rpr.position_id= rup.position_id
and rpr.role_id= ra.role_id and ra.appl = 'RA/BIP'
AND RUP.position_id in (64,65,66);



